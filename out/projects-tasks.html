<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Projects & Tasks - Tempus Productivity Dashboard</title>
  
  <!-- Emergency fix for modal auto-opening -->
  <style>
    /* Initially hide all modals by default */
    #new-task-modal, #new-project-modal {
      display: none !important;
    }
  </style>
  
  <script>
    // Highest priority script to prevent modals from auto-opening
    window.addEventListener('DOMContentLoaded', function() {
      console.log('Emergency modal fix applied');
      
      // Force close any modals
      const taskModal = document.getElementById('new-task-modal');
      const projectModal = document.getElementById('new-project-modal');
      
      if (taskModal) {
        taskModal.style.display = 'none';
        taskModal.classList.remove('active');
      }
      
      if (projectModal) {
        projectModal.style.display = 'none';
        projectModal.classList.remove('active');
      }
    }, true); // Use capture phase to ensure this runs first
  </script>
  
  <script>
    // Force close modals on page load
    window.addEventListener('load', function() {
      console.log('Force closing any open modals');
      
      // Close task modal
      var taskModal = document.getElementById('new-task-modal');
      if (taskModal) {
        taskModal.style.display = 'none';
        taskModal.classList.remove('active');
      }
      
      // Close project modal
      var projectModal = document.getElementById('new-project-modal');
      if (projectModal) {
        projectModal.style.display = 'none';
        projectModal.classList.remove('active');
      }
    });
  </script>
  
  <!-- CRITICAL FIX: Forcibly override modal functions -->
  <script>
    // Create a global function that will run before any other scripts
    window.addEventListener('load', function() {
      console.log('CRITICAL FIX: Forcibly closing all modals');
      
      // Force close all modals
      const allModals = document.querySelectorAll('.modal, [id*="modal"]');
      allModals.forEach(function(modal) {
        modal.style.display = 'none';
        modal.classList.remove('active', 'show', 'show-modal', 'visible');
        modal.style.opacity = '0';
        modal.style.visibility = 'hidden';
      });
      
      // Override all modal open functions
      if (typeof openNewTaskModal === 'function') {
        const originalOpenTaskModal = openNewTaskModal;
        window.openNewTaskModal = function(e) {
          // Only open if directly called by a button click
          if (e && e.type === 'click') {
            console.log('Task modal opened via button click');
            return originalOpenTaskModal.apply(this, arguments);
          }
          console.log('Prevented automatic task modal opening');
          return false;
        };
      }
      
      if (typeof openNewProjectModal === 'function') {
        const originalOpenProjectModal = openNewProjectModal;
        window.openNewProjectModal = function(e) {
          // Only open if directly called by a button click
          if (e && e.type === 'click') {
            console.log('Project modal opened via button click');
            return originalOpenProjectModal.apply(this, arguments);
          }
          console.log('Prevented automatic project modal opening');
          return false;
        };
      }
      
      // Fix button click handlers
      setTimeout(function() {
        console.log('Setting up proper button handlers');
        
        // Fix New Task button
        const newTaskBtn = document.getElementById('new-task-btn');
        if (newTaskBtn) {
          // Clean up existing handlers
          const newTaskBtnClone = newTaskBtn.cloneNode(true);
          if (newTaskBtn.parentNode) {
            newTaskBtn.parentNode.replaceChild(newTaskBtnClone, newTaskBtn);
          }
          
          // Add proper handler that explicitly adds the show-modal class
          newTaskBtnClone.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('New Task button clicked properly');
            
            const modal = document.getElementById('new-task-modal');
            if (modal) {
              // Populate project dropdown
              const projectSelect = document.getElementById('new-task-project');
              if (projectSelect) {
                projectSelect.innerHTML = '';
                const projects = document.querySelectorAll('.project-card');
                
                if (projects.length === 0) {
                  alert('Please create a project first before adding tasks.');
                  return;
                }
                
                projects.forEach(project => {
                  const projectTitle = project.querySelector('.project-title');
                  const projectId = project.getAttribute('data-project-id') || 
                                   (project.id ? project.id : 'project-' + Date.now());
                  
                  if (projectTitle) {
                    const option = document.createElement('option');
                    option.value = projectId;
                    option.textContent = projectTitle.textContent;
                    projectSelect.appendChild(option);
                  }
                });
              }
              
              // Reset form
              const form = document.getElementById('new-task-form');
              if (form) form.reset();
              
              // Show modal using the reliable show-modal class
              modal.style.display = 'flex';
              modal.classList.add('show-modal', 'active');
            }
          });
        }
        
        // Fix New Project button
        const newProjectBtn = document.getElementById('new-project-btn');
        if (newProjectBtn) {
          // Clean up existing handlers
          const newProjectBtnClone = newProjectBtn.cloneNode(true);
          if (newProjectBtn.parentNode) {
            newProjectBtn.parentNode.replaceChild(newProjectBtnClone, newProjectBtn);
          }
          
          // Add proper handler that explicitly adds the show-modal class
          newProjectBtnClone.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            console.log('New Project button clicked properly');
            
            const modal = document.getElementById('new-project-modal');
            if (modal) {
              // Reset form
              const form = document.getElementById('new-project-form');
              if (form) form.reset();
              
              // Show modal using the reliable show-modal class
              modal.style.display = 'flex';
              modal.classList.add('show-modal', 'active');
              
              // Focus name input
              const nameInput = document.getElementById('new-project-name');
              if (nameInput) {
                setTimeout(() => {
                  nameInput.focus();
                }, 100);
              }
            }
          });
        }
        
        // Fix cancel buttons
        document.querySelectorAll('.close-modal, button:contains("Cancel")').forEach(button => {
          button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Find the closest modal
            const modal = this.closest('.modal') || 
                          this.closest('[id*="modal"]');
            
            if (modal) {
              // Hide modal
              modal.style.display = 'none';
              modal.classList.remove('show-modal', 'active');
            }
          });
        });
      }, 300);
    }, true); // Use capture phase to ensure this runs first
  </script>
  
  <link rel="stylesheet" href="production-fix.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #4f46e5, #7c3aed);
      --accent-color: #4f46e5;
      --accent-hover: #4338ca;
      --text-primary: #333;
      --text-secondary: #6b7280;
      --background-primary: #f9fafb;
      --background-secondary: #f3f4f6;
      --background-hover: #e5e7eb;
      --card-bg: #ffffff;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-hover: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --transition-sm: 0.2s;
      --transition-md: 0.3s;
    }
    
    [data-theme="dark"] {
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --background-primary: #111827;
      --background-secondary: #1f2937;
      --background-hover: #374151;
      --card-bg: #1f2937;
      --border-color: #374151;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--background-primary);
      color: var(--text-primary);
      margin: 0;
      transition: background-color var(--transition-md);
    }

    /* Make interactive elements work properly */
    button, .btn, input[type="checkbox"] {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    .task-actions {
      opacity: 0;
      visibility: visible !important;
      transition: opacity 0.2s ease;
    }
    
    .task-item:hover .task-actions,
    .project-header:hover .task-actions {
      opacity: 1 !important;
    }
    
    .modal-overlay:not(.active) {
      display: none !important;
    }
    
    /* Enhanced Project Card Styles */
    .projects-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1.5rem;
      padding: 1.5rem;
    }
    
    .project-card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      overflow: hidden;
      transition: transform var(--transition-sm), box-shadow var(--transition-md);
      border-top: 4px solid var(--project-color, var(--accent-color));
    }
    
    .project-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .project-header {
      padding: 1.25rem 1.25rem 0.75rem;
      position: relative;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .project-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .project-progress {
      margin-top: 0.5rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }
    
    .progress-bar {
      margin: 0.75rem 0 1rem;
      height: 0.375rem;
      background-color: var(--background-secondary);
      border-radius: 1rem;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      border-radius: 1rem;
      background-image: var(--primary-gradient);
      transition: width 0.5s ease;
    }
    
    /* Enhanced Task Item Styles */
    .task-list {
      padding: 0 1.25rem 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .task-item {
      background: var(--background-secondary);
      border-radius: var(--radius-md);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      transition: background-color var(--transition-sm), transform var(--transition-sm);
    }
    
    .task-item:hover {
      background-color: var(--background-hover);
      transform: translateX(2px);
    }
    
    .task-checkbox {
      position: relative;
      appearance: none;
      -webkit-appearance: none;
      width: 1.25rem;
      height: 1.25rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-sm);
      cursor: pointer;
      flex-shrink: 0;
      margin-top: 0.125rem;
      transition: border-color var(--transition-sm), background-color var(--transition-sm);
    }
    
    .task-checkbox:checked {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
    }
    
    .task-checkbox:checked::after {
      content: "";
      position: absolute;
      top: 0.2rem;
      left: 0.4rem;
      width: 0.25rem;
      height: 0.5rem;
      border: solid white;
      border-width: 0 0.125rem 0.125rem 0;
      transform: rotate(45deg);
    }
    
    .task-content {
      flex: 1;
    }
    
    .task-name {
      font-weight: 500;
      margin: 0 0 0.25rem;
      color: var(--text-primary);
    }
    
    .task-details {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.875rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    
    .task-detail {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }
    
    .task-detail .material-icons {
      font-size: 0.875rem;
    }
    
    /* Button Styles */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.625rem 1.25rem;
      border-radius: var(--radius-md);
      font-weight: 500;
      font-size: 0.875rem;
      transition: all var(--transition-sm);
      border: none;
    }
    
    .primary-btn {
      background-image: var(--primary-gradient);
      color: white;
      box-shadow: var(--shadow-sm);
    }
    
    .primary-btn:hover {
      opacity: 0.9;
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }
    
    .secondary-btn {
      background-color: var(--background-secondary);
      color: var(--text-primary);
    }
    
    .secondary-btn:hover {
      background-color: var(--background-hover);
    }
    
    /* Action Button Styles */
    .task-action-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      width: 28px;
      height: 28px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      transition: background-color var(--transition-sm), color var(--transition-sm);
    }
    
    .task-action-btn:hover {
      background-color: var(--background-hover);
      color: var(--accent-color);
    }
    
    .task-action-btn .material-icons {
      font-size: 18px;
    }
    
    /* Priority Colors */
    .priority-high {
      color: #ef4444;
    }
    
    .priority-medium {
      color: #f59e0b;
    }
    
    .priority-low {
      color: #10b981;
    }
    
    /* Filters Style */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--card-bg);
      box-shadow: var(--shadow-sm);
      margin-bottom: 1rem;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .filter-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0;
    }
    
    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .filter-btn {
      background-color: var(--background-secondary);
      border: none;
      border-radius: 2rem;
      padding: 0.375rem 0.875rem;
      font-size: 0.8125rem;
      cursor: pointer;
      transition: background-color var(--transition-sm), color var(--transition-sm);
    }
    
    .filter-btn.active {
      background-color: var(--accent-color);
      color: white;
      font-weight: 500;
    }
    
    .filter-btn:hover:not(.active) {
      background-color: var(--background-hover);
    }
    
    /* Header Style */
    .header {
      padding: 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }
    
    .header-title h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .header-title p {
      margin: 0.25rem 0 0;
      font-size: 0.875rem;
      color: var(--text-secondary);
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-content {
      background-color: white;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
      color: #111827;
    }

    .modal-close {
      background: none;
      border: none;
      cursor: pointer;
      color: #6b7280;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 4px;
      border-radius: 4px;
    }

    .modal-close:hover {
      background-color: #f3f4f6;
      color: #1f2937;
    }

    .modal-body {
      padding: 20px;
      flex: 1;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      color: #374151;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.875rem;
      transition: border-color 0.15s ease;
    }

    .form-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .color-picker {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .color-input {
      height: 40px;
      padding: 4px;
    }

    .color-presets {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .color-preset {
      width: 36px;
      height: 36px;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      border: 2px solid transparent;
    }

    .color-preset:hover {
      transform: scale(1.1);
    }

    .color-preset.active {
      border-color: #111827;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #4f46e5;
    }

    .priority-options {
      display: flex;
      gap: 12px;
    }

    .priority-option {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .priority-label {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .low-priority {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .medium-priority {
      background-color: #fef3c7;
      color: #92400e;
    }

    .high-priority {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .priority-high {
      color: #ef4444;
    }

    .priority-medium {
      color: #f59e0b;
    }

    .priority-low {
      color: #3b82f6;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 16px;
      font-weight: 500;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }

    .primary-btn {
      background-color: #4f46e5;
      color: white;
    }

    .primary-btn:hover {
      background-color: #4338ca;
    }

    .secondary-btn {
      background-color: white;
      border-color: #d1d5db;
      color: #374151;
    }

    .secondary-btn:hover {
      background-color: #f9fafb;
      color: #111827;
    }
    
    /* Animation for tasks and projects */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .project-card {
      animation: fadeIn 0.5s ease forwards;
    }
    
    .task-item {
      animation: slideIn 0.3s ease forwards;
    }
    
    /* Color picker styles */
    .color-picker {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .color-input {
      height: 2.5rem;
      padding: 0.25rem;
      width: 5rem;
      cursor: pointer;
    }
    
    .color-presets {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .color-preset {
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 0.375rem;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: var(--shadow-sm);
    }
    
    .color-preset:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }
    
    .color-preset.active {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }
    
    /* Modal close button */
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      width: 2rem;
      height: 2rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s, color 0.2s;
    }
    
    .modal-close:hover {
      background-color: var(--background-hover);
      color: var(--text-primary);
    }
    
    /* Modal animation */
    .modal-overlay.active .modal-content {
      animation: modalSlideIn 0.3s ease forwards;
    }
    
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Make edit and delete buttons more visible */
    .project-header .task-actions,
    .task-item .task-actions {
      opacity: 0;
      transition: opacity 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .project-card:hover .project-header .task-actions,
    .task-item:hover .task-actions {
      opacity: 1;
    }
    
    /* Style the edit and delete buttons */
    .task-action-btn {
      background: none;
      border: none;
      color: #6b7280;
      cursor: pointer;
      padding: 4px;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .task-action-btn:hover {
      background-color: #f3f4f6;
      color: #1f2937;
    }
    
    /* Add specific style for edit button */
    .task-action-btn .material-icons {
      font-size: 18px;
    }
    
    /* Ensure action buttons are always visible on mobile */
    @media (max-width: 768px) {
      .project-header .task-actions,
      .task-item .task-actions {
        opacity: 1;
      }
    }

    /* Dashboard header styling */
    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1.5rem;
      background-color: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
    }
    
    .dashboard-header h1 {
      margin: 0;
      font-size: 1.75rem;
      color: var(--text-primary);
    }
    
    .dashboard-actions {
      display: flex;
      gap: 0.75rem;
    }
    
    /* Finish adding style for completed tasks */
    .task-item.completed {
      opacity: 0.7;
    }
    
    .task-item.completed .task-name {
      text-decoration: line-through;
      color: var(--text-secondary);
    }
    
    /* Make sure buttons are always clickable */
    button, .btn {
      position: relative;
      z-index: 10;
      cursor: pointer !important;
      pointer-events: auto !important;
    }
    
    /* Make all actions visible on small screens */
    @media (max-width: 768px) {
      .task-actions {
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="sidebar">
      <div class="logo">
        <div class="logo-icon">
          <span class="material-icons">schedule</span>
        </div>
        <span>tempus.</span>
      </div>
      
      <div class="nav-section">
        <a href="index.html" class="nav-item">
          <span class="material-icons nav-icon">dashboard</span>
          <span>Dashboard</span>
        </a>
        <a href="calendar.html" class="nav-item">
          <span class="material-icons nav-icon">calendar_today</span>
          <span>Calendar</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">PRODUCTIVITY</div>
        <a href="projects-tasks.html" class="nav-item active">
          <span class="material-icons nav-icon">folder</span>
          <span>Projects & tasks</span>
        </a>
        <a href="timer.html" class="nav-item">
          <span class="material-icons nav-icon">timer</span>
          <span>Timer</span>
        </a>
        <a href="history.html" class="nav-item">
          <span class="material-icons nav-icon">history</span>
          <span>History</span>
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">RESOURCES</div>
        <a href="youtube-manager.html" class="nav-item">
          <span class="material-icons nav-icon">video_library</span>
          <span>YouTube Manager</span>
        </a>
      </div>
      
      <div class="nav-section" style="margin-top: auto; padding-bottom: 16px;">
        <a href="help.html" class="nav-item">
          <span class="material-icons nav-icon">help_outline</span>
          <span>Help</span>
        </a>
        <a href="settings.html" class="nav-item">
          <span class="material-icons nav-icon">settings</span>
          <span>Settings</span>
        </a>
        <a href="#" class="nav-item" id="logout-btn">
          <span class="material-icons nav-icon">logout</span>
          <span>Log Out</span>
        </a>
      </div>
    </div>
    
    <div class="main-content">
      <div class="dashboard-header">
        <h1>Projects & Tasks</h1>
        <div class="dashboard-actions">
          <button id="new-project-btn" class="btn primary-btn">
            <span class="material-icons">add</span> New Project
          </button>
          <button id="new-task-btn" class="btn primary-btn">
            <span class="material-icons">add</span> New Task
          </button>
        </div>
      </div>
  
      <div class="content-area">
        <div class="filters">
          <div class="filter-group">
            <p class="filter-title">Status</p>
            <div class="filter-options">
              <button class="filter-btn active">All</button>
              <button class="filter-btn">Active</button>
              <button class="filter-btn">Completed</button>
            </div>
          </div>
          <div class="filter-group">
            <p class="filter-title">Priority</p>
            <div class="filter-options">
              <button class="filter-btn active">All</button>
              <button class="filter-btn">High</button>
              <button class="filter-btn">Medium</button>
              <button class="filter-btn">Low</button>
            </div>
          </div>
          <div class="filter-group">
            <p class="filter-title">Project</p>
            <div class="filter-options">
              <button class="filter-btn active">All</button>
              <button class="filter-btn">Website</button>
              <button class="filter-btn">Mobile App</button>
              <button class="filter-btn">Marketing</button>
            </div>
          </div>
        </div>
        
        <div class="projects-container">
          <!-- Website Redesign Project -->
          <div class="project-card" style="--project-color: #4f46e5;">
            <div class="project-header">
              <div>
                <h3 class="project-title">Website Redesign</h3>
                <p class="project-progress">70% complete</p>
              </div>
              <div class="task-actions" style="opacity: 1;">
                <button class="task-action-btn">
                  <span class="material-icons">edit</span>
                </button>
                <button class="task-action-btn">
                  <span class="material-icons">more_vert</span>
                </button>
              </div>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" style="width: 70%;"></div>
            </div>
            
            <div class="task-list">
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Update homepage design</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-high">flag</span>
                      High
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      3h
                    </span>
                    <span class="task-detail deadline-approaching">
                      <span class="material-icons">event</span>
                      Today
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item completed">
                <input type="checkbox" class="task-checkbox" checked>
                <div class="task-content">
                  <h4 class="task-name">Create wireframes</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-medium">flag</span>
                      Medium
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      5h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 18
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Implement responsive layout</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-medium">flag</span>
                      Medium
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      6h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 20
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Mobile App Project -->
          <div class="project-card" style="--project-color: #10b981;">
            <div class="project-header">
              <div>
                <h3 class="project-title">Mobile App</h3>
                <p class="project-progress">45% complete</p>
              </div>
              <div class="task-actions" style="opacity: 1;">
                <button class="task-action-btn">
                  <span class="material-icons">edit</span>
                </button>
                <button class="task-action-btn">
                  <span class="material-icons">more_vert</span>
                </button>
              </div>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" style="width: 45%;"></div>
            </div>
            
            <div class="task-list">
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Design user profile screen</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-high">flag</span>
                      High
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      4h
                    </span>
                    <span class="task-detail deadline-approaching">
                      <span class="material-icons">event</span>
                      Tomorrow
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item completed">
                <input type="checkbox" class="task-checkbox" checked>
                <div class="task-content">
                  <h4 class="task-name">Implement login system</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-high">flag</span>
                      High
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      8h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 15
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Create push notification system</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-medium">flag</span>
                      Medium
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      5h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 22
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Marketing Campaign Project -->
          <div class="project-card" style="--project-color: #f59e0b;">
            <div class="project-header">
              <div>
                <h3 class="project-title">Marketing Campaign</h3>
                <p class="project-progress">20% complete</p>
              </div>
              <div class="task-actions" style="opacity: 1;">
                <button class="task-action-btn">
                  <span class="material-icons">edit</span>
                </button>
                <button class="task-action-btn">
                  <span class="material-icons">more_vert</span>
                </button>
              </div>
            </div>
            
            <div class="progress-bar">
              <div class="progress-fill" style="width: 20%;"></div>
            </div>
            
            <div class="task-list">
              <div class="task-item completed">
                <input type="checkbox" class="task-checkbox" checked>
                <div class="task-content">
                  <h4 class="task-name">Define target audience</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-high">flag</span>
                      High
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      3h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 16
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Create social media content</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-medium">flag</span>
                      Medium
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      6h
                    </span>
                    <span class="task-detail deadline-approaching">
                      <span class="material-icons">event</span>
                      Apr 19
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
              
              <div class="task-item">
                <input type="checkbox" class="task-checkbox">
                <div class="task-content">
                  <h4 class="task-name">Set up ad campaigns</h4>
                  <div class="task-details">
                    <span class="task-detail">
                      <span class="material-icons priority-low">flag</span>
                      Low
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">schedule</span>
                      4h
                    </span>
                    <span class="task-detail">
                      <span class="material-icons">event</span>
                      Apr 25
                    </span>
                  </div>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">delete</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Edit Task Modal -->
  <div class="modal-overlay" id="edit-task-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Edit Task</h3>
        <button class="modal-close" id="edit-task-close">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="edit-task-form">
          <div class="form-group">
            <label for="edit-task-name" class="form-label">Task Name</label>
            <input type="text" id="edit-task-name" class="form-input" placeholder="Enter task name" required>
          </div>
          
          <div class="form-group">
            <label class="form-label">Priority</label>
            <div class="priority-options" id="edit-task-priority-display">
              <div class="priority-option">
                <input type="radio" name="edit-task-priority" id="edit-priority-high" value="high">
                <label for="edit-priority-high" class="priority-label priority-high">
                  <span class="material-icons">flag</span>
                  High
                </label>
              </div>
              <div class="priority-option">
                <input type="radio" name="edit-task-priority" id="edit-priority-medium" value="medium" checked>
                <label for="edit-priority-medium" class="priority-label priority-medium">
                  <span class="material-icons">outlined_flag</span>
                  Medium
                </label>
              </div>
              <div class="priority-option">
                <input type="radio" name="edit-task-priority" id="edit-priority-low" value="low">
                <label for="edit-priority-low" class="priority-label priority-low">
                  <span class="material-icons">assistant_flag</span>
                  Low
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label for="edit-task-time" class="form-label">Estimated Time (hours)</label>
            <input type="number" id="edit-task-time" class="form-input" value="1" min="0.5" step="0.5">
          </div>
          
          <div class="form-group">
            <label for="edit-task-deadline" class="form-label">Deadline (optional)</label>
            <input type="date" id="edit-task-deadline" class="form-input">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn secondary-btn" id="edit-task-cancel">Cancel</button>
        <button class="btn primary-btn" id="edit-task-save">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- New Task Modal -->
  <div id="new-task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create New Task</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="new-task-form">
          <div class="form-group">
            <label for="new-task-name">Task Name</label>
            <input type="text" id="new-task-name" required>
          </div>
          <div class="form-group">
            <label for="new-task-project">Project</label>
            <select id="new-task-project" required></select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <div class="priority-options">
              <label class="priority-option">
                <input type="radio" name="new-task-priority" value="low" checked>
                <span class="priority-label priority-low">
                  <span class="material-icons">assistant_flag</span>Low
                </span>
              </label>
              <label class="priority-option">
                <input type="radio" name="new-task-priority" value="medium">
                <span class="priority-label priority-medium">
                  <span class="material-icons">outlined_flag</span>Medium
                </span>
              </label>
              <label class="priority-option">
                <input type="radio" name="new-task-priority" value="high">
                <span class="priority-label priority-high">
                  <span class="material-icons">flag</span>High
                </span>
              </label>
            </div>
          </div>
          <div class="form-group">
            <label for="new-task-time">Estimated Time</label>
            <input type="text" id="new-task-time" placeholder="e.g. 2h 30m">
          </div>
          <div class="form-group">
            <label for="new-task-deadline">Deadline (optional)</label>
            <input type="date" id="new-task-deadline">
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary-btn close-modal">Cancel</button>
            <button type="button" id="create-task-btn" class="btn primary-btn">Create Task</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- New Project Modal -->
  <div id="new-project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create New Project</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="new-project-form">
          <div class="form-group">
            <label for="new-project-name">Project Name</label>
            <input type="text" id="new-project-name" required>
          </div>
          <div class="form-group">
            <label for="new-project-color">Project Color</label>
            <div class="color-selector">
              <input type="color" id="new-project-color" value="#4f46e5">
              <div class="color-presets">
                <div class="color-preset active" data-color="#4f46e5" style="background-color: #4f46e5;"></div>
                <div class="color-preset" data-color="#10b981" style="background-color: #10b981;"></div>
                <div class="color-preset" data-color="#f59e0b" style="background-color: #f59e0b;"></div>
                <div class="color-preset" data-color="#ef4444" style="background-color: #ef4444;"></div>
                <div class="color-preset" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary-btn close-modal">Cancel</button>
            <button type="button" id="create-project-btn" class="btn primary-btn">Create Project</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Main JavaScript -->
  <script>
    // Add debounce function to prevent multiple rapid function executions
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }
    
    // Function to create a notification element
    function showNotification(message, type = 'success') {
      // If notification container doesn't exist, create it
      let notificationContainer = document.getElementById('notification-container');
      if (!notificationContainer) {
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        document.body.appendChild(notificationContainer);
      }
      
      // Create or get notification element
      let notification = notificationContainer.querySelector('.notification');
      if (!notification) {
        notification = document.createElement('div');
        notification.className = 'notification';
        notificationContainer.appendChild(notification);
        console.log('Created new notification element');
      }
      
      // Set content and type
      notification.className = 'notification';
      if (type === 'error') {
        notification.classList.add('error');
        notification.innerHTML = `<span class="material-icons">error</span> ${message}`;
      } else {
        notification.classList.add('success');
        notification.innerHTML = `<span class="material-icons">check_circle</span> ${message}`;
      }
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('active');
        console.log('Notification activated');
        
        // Hide after 4 seconds
        setTimeout(() => {
          notification.classList.remove('active');
          console.log('Notification hidden');
        }, 4000);
      }, 10);
    }

    // Function to show confirmation dialog
    function showConfirmDialog(message, onConfirm) {
      // Create or get confirm dialog element
      let confirmDialog = document.getElementById('confirm-dialog');
      
      if (!confirmDialog) {
        confirmDialog = document.createElement('div');
        confirmDialog.id = 'confirm-dialog';
        confirmDialog.className = 'confirm-dialog';
        
        confirmDialog.innerHTML = `
          <div class="confirm-dialog-message"></div>
          <div class="confirm-dialog-actions">
            <button class="btn secondary-btn" id="confirm-cancel">Cancel</button>
            <button class="btn primary-btn" id="confirm-ok">Confirm</button>
          </div>
        `;
        
        document.body.appendChild(confirmDialog);
        
        // Add event listeners to the buttons
        document.getElementById('confirm-cancel').addEventListener('click', function() {
          confirmDialog.classList.remove('active');
        });
      }
      
      // Set message
      confirmDialog.querySelector('.confirm-dialog-message').textContent = message;
      
      // Set confirm action
      const okButton = document.getElementById('confirm-ok');
      
      // Remove existing listener to avoid duplicates
      const newOkButton = okButton.cloneNode(true);
      okButton.parentNode.replaceChild(newOkButton, okButton);
      
      newOkButton.addEventListener('click', function() {
        confirmDialog.classList.remove('active');
        if (typeof onConfirm === 'function') {
          onConfirm();
        }
      });
      
      // Show dialog
      confirmDialog.classList.add('active');
    }
  </script>

  <!-- Initialize dark mode -->
  <script>
    // Initialize dark mode
    function loadDarkModePreference() {
      const isDarkMode = localStorage.getItem('tempus-dark-mode') === 'true';
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
      } else {
        document.body.classList.remove('dark-mode');
      }
    }
    
    // Load dark mode on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadDarkModePreference();
      
      // Add event listeners to checkboxes
      document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const taskItem = this.closest('.task-item');
          if (this.checked) {
            taskItem.classList.add('completed');
          } else {
            taskItem.classList.remove('completed');
          }
          
          // Update project progress
          updateProjectProgress(this.closest('.project-card'));
        });
      });
      
      // Add event listeners to filter buttons
      document.querySelectorAll('.filter-options').forEach(filterGroup => {
        filterGroup.querySelectorAll('.filter-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            filterGroup.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            applyFilters();
          });
        });
      });
    });
    
    // Update project progress
    function updateProjectProgress(projectCard) {
      const totalTasks = projectCard.querySelectorAll('.task-item').length;
      const completedTasks = projectCard.querySelectorAll('.task-item.completed').length;
      const progressPercentage = Math.round((completedTasks / totalTasks) * 100);
      
      projectCard.querySelector('.project-progress').textContent = `${progressPercentage}% complete`;
      projectCard.querySelector('.progress-fill').style.width = `${progressPercentage}%`;
    }
    
    // Apply filters
    function applyFilters() {
      // This would normally filter tasks based on selected filters
      console.log('Applying filters...');
    }
    
    // Enable drag and drop for tasks (simulated)
    document.querySelectorAll('.task-item').forEach(task => {
      task.setAttribute('draggable', 'true');
      
      task.addEventListener('dragstart', function(e) {
        e.dataTransfer.setData('text/plain', task.querySelector('.task-name').textContent);
        task.classList.add('dragging');
      });
      
      task.addEventListener('dragend', function() {
        task.classList.remove('dragging');
      });
    });
    
    document.querySelectorAll('.task-list').forEach(list => {
      list.addEventListener('dragover', function(e) {
        e.preventDefault();
      });
      
      list.addEventListener('drop', function(e) {
        e.preventDefault();
        const draggingTask = document.querySelector('.dragging');
        if (draggingTask) {
          // In a real app, we would update the task's project here
          console.log(`Moved task to ${this.closest('.project-card').querySelector('.project-title').textContent}`);
        }
      });
    });
    
    // Modal functionality
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Edit task functionality
    function editTask(taskItem) {
      const taskName = taskItem.querySelector('.task-name').textContent;
      const priorityElement = taskItem.querySelector('.task-detail .material-icons[class*="priority-"]');
      let priority = 'medium';
      
      if (priorityElement.classList.contains('priority-high')) {
        priority = 'high';
      } else if (priorityElement.classList.contains('priority-medium')) {
        priority = 'medium';
      } else if (priorityElement.classList.contains('priority-low')) {
        priority = 'low';
      }
      
      const estimatedTimeText = taskItem.querySelector('.task-detail:nth-child(2)').textContent.trim();
      const estimatedTime = parseInt(estimatedTimeText) || 1;
      
      const deadlineText = taskItem.querySelector('.task-detail:nth-child(3)').textContent.trim();
      let deadlineDate = '';
      
      // Try to convert deadline text to a date input value
      if (deadlineText === 'Today') {
        deadlineDate = new Date().toISOString().split('T')[0];
      } else if (deadlineText === 'Tomorrow') {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        deadlineDate = tomorrow.toISOString().split('T')[0];
      } else if (deadlineText.startsWith('Apr')) {
        // Assuming April 2023
        const day = parseInt(deadlineText.replace('Apr ', ''));
        deadlineDate = `2023-04-${day.toString().padStart(2, '0')}`;
      }
      
      // Set values in edit form
      document.getElementById('edit-task-name').value = taskName;
      document.getElementById('edit-task-priority').value = priority;
      document.getElementById('edit-task-time').value = estimatedTime;
      document.getElementById('edit-task-deadline').value = deadlineDate;
      
      // Store reference to the task item being edited
      document.getElementById('edit-task-id').value = taskItem.dataset.id || Date.now().toString();
      document.getElementById('edit-project-id').value = taskItem.closest('.project-card').dataset.id || 'unknown';
      
      // Open edit modal
      openModal('edit-task-modal');
    }
    
    function saveTaskEdit() {
      // Validate form
      const taskNameInput = document.getElementById('edit-task-name');
      const taskTimeInput = document.getElementById('edit-task-time');
      
      if (!taskNameInput.value.trim()) {
        taskNameInput.classList.add('error');
        return;
      } else {
        taskNameInput.classList.remove('error');
      }
      
      if (!taskTimeInput.value || isNaN(taskTimeInput.value) || taskTimeInput.value < 1) {
        taskTimeInput.classList.add('error');
        return;
      } else {
        taskTimeInput.classList.remove('error');
      }
      
      // Get form values
      const taskId = document.getElementById('edit-task-id').value;
      const projectId = document.getElementById('edit-project-id').value;
      const taskName = taskNameInput.value;
      const priority = document.getElementById('edit-task-priority').value;
      const estimatedTime = taskTimeInput.value;
      const deadline = document.getElementById('edit-task-deadline').value;
      
      // Find the task item
      const taskItem = document.querySelector(`.task-item[data-id="${taskId}"]`) || 
                      Array.from(document.querySelectorAll('.task-item')).find(item => 
                        item.querySelector('.task-name').textContent === document.getElementById('edit-task-name').value);
      
      if (taskItem) {
        // Update task name
        taskItem.querySelector('.task-name').textContent = taskName;
        
        // Update priority
        const priorityIcon = taskItem.querySelector('.task-detail:nth-child(1) .material-icons');
        priorityIcon.classList.remove('priority-high', 'priority-medium', 'priority-low');
        priorityIcon.classList.add(`priority-${priority}`);
        taskItem.querySelector('.task-detail:nth-child(1)').textContent = priority.charAt(0).toUpperCase() + priority.slice(1);
        taskItem.querySelector('.task-detail:nth-child(1)').prepend(priorityIcon);
        
        // Update estimated time
        taskItem.querySelector('.task-detail:nth-child(2)').innerHTML = `<span class="material-icons">schedule</span> ${estimatedTime}h`;
        
        // Update deadline
        const deadlineDetail = taskItem.querySelector('.task-detail:nth-child(3)');
        deadlineDetail.classList.remove('deadline-approaching', 'deadline-overdue');
        
        let deadlineText = '';
        if (deadline) {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          
          const deadlineDate = new Date(deadline);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          if (deadlineDate.getTime() === today.getTime()) {
            deadlineText = 'Today';
            deadlineDetail.classList.add('deadline-approaching');
          } else if (deadlineDate.getTime() === tomorrow.getTime()) {
            deadlineText = 'Tomorrow';
            deadlineDetail.classList.add('deadline-approaching');
          } else if (deadlineDate < today) {
            const options = { month: 'short', day: 'numeric' };
            deadlineText = deadlineDate.toLocaleDateString('en-US', options);
            deadlineDetail.classList.add('deadline-overdue');
          } else {
            const options = { month: 'short', day: 'numeric' };
            deadlineText = deadlineDate.toLocaleDateString('en-US', options);
            
            // If within a week, mark as approaching
            const oneWeek = new Date(today);
            oneWeek.setDate(oneWeek.getDate() + 7);
            if (deadlineDate <= oneWeek) {
              deadlineDetail.classList.add('deadline-approaching');
            }
          }
        } else {
          deadlineText = 'No deadline';
        }
        
        deadlineDetail.innerHTML = `<span class="material-icons">event</span> ${deadlineText}`;
        
        // Set data attributes for future editing
        taskItem.dataset.id = taskId;
        taskItem.dataset.priority = priority;
        taskItem.dataset.time = estimatedTime;
        taskItem.dataset.deadline = deadline;
        
        // Update project progress
        updateProjectProgress(taskItem.closest('.project-card'));
      }
      
      // Close modal
      closeModal('edit-task-modal');
    }
    
    // Delete task functionality
    function deleteTask(taskItem) {
      // Set up the confirmation tooltip
      const tooltip = document.getElementById('delete-tooltip');
      const rect = taskItem.getBoundingClientRect();
      
      tooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
      tooltip.style.left = `${rect.right + window.scrollX - tooltip.offsetWidth}px`;
      tooltip.classList.add('active');
      
      // Store the task item to be deleted
      tooltip.dataset.taskId = taskItem.dataset.id || '';
      tooltip.dataset.taskElement = Array.from(document.querySelectorAll('.task-item')).indexOf(taskItem);
    }
    
    function confirmDeleteTask() {
      const tooltip = document.getElementById('delete-tooltip');
      const taskIndex = parseInt(tooltip.dataset.taskElement);
      
      if (!isNaN(taskIndex) && taskIndex >= 0) {
        const taskItems = document.querySelectorAll('.task-item');
        if (taskIndex < taskItems.length) {
          const taskItem = taskItems[taskIndex];
          const projectCard = taskItem.closest('.project-card');
          
          // Remove the task item with animation
          taskItem.style.opacity = '0';
          taskItem.style.height = '0';
          taskItem.style.margin = '0';
          taskItem.style.padding = '0';
          taskItem.style.overflow = 'hidden';
          
          setTimeout(() => {
            taskItem.remove();
            updateProjectProgress(projectCard);
          }, 300);
        }
      }
      
      // Hide tooltip
      tooltip.classList.remove('active');
    }
    
    function cancelDeleteTask() {
      document.getElementById('delete-tooltip').classList.remove('active');
    }
    
    // Function to save a new task
    function saveNewTask() {
      // Prevent multiple submissions
      if (isTaskSubmitting) {
        console.log('Task submission already in progress, ignoring duplicate call');
        return false;
      }
      
      try {
        console.log('saveNewTask called');
        isTaskSubmitting = true;
        
        // Check if the modal is visible
        const modal = document.getElementById('new-task-modal');
        console.log('Modal exists:', !!modal);
        console.log('Modal visible:', modal && modal.classList.contains('active'));
        
        // Log all form elements before trying to access them
        console.log('Form exists:', !!document.getElementById('new-task-form'));
        console.log('Name input exists:', !!document.getElementById('new-task-name'));
        console.log('Project select exists:', !!document.getElementById('new-task-project'));
        console.log('Time input exists:', !!document.getElementById('new-task-time'));
        
        // Get form values
        const taskNameElement = document.getElementById('new-task-name');
        if (!taskNameElement) {
          console.error('Task name element not found!');
          showNotification('Error: Task name field not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        const taskName = taskNameElement.value;
        console.log('Task name:', taskName);
        
        const projectSelect = document.getElementById('new-task-project');
        if (!projectSelect) {
          console.error('Project select element not found!');
          showNotification('Error: Project select field not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        console.log('Project select element found:', projectSelect);
        
        let projectName = '';
        
        // Check if there are options in the select
        if (projectSelect && projectSelect.options.length > 0) {
          const selectedIndex = projectSelect.selectedIndex;
          if (selectedIndex >= 0) {
            projectName = projectSelect.options[selectedIndex].text;
          }
        }
        
        console.log("Selected project:", projectName);
        
        // Check if priority radio buttons exist and at least one is checked
        const priorityRadios = document.querySelectorAll('input[name="new-task-priority"]');
        if (priorityRadios.length === 0) {
          console.error('Priority radio buttons not found!');
          showNotification('Error: Priority selection not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        let priority = 'medium'; // Default value
        const checkedPriority = document.querySelector('input[name="new-task-priority"]:checked');
        if (checkedPriority) {
          priority = checkedPriority.value;
        } else {
          console.warn('No priority selected, using default: medium');
        }
        console.log('Priority:', priority);
        
        // Get estimated time
        const timeElement = document.getElementById('new-task-time');
        let estTime = '1'; // Default value
        if (timeElement) {
          estTime = timeElement.value || '1';
        } else {
          console.warn('Time element not found, using default: 1');
        }
        console.log('Estimated time:', estTime);
        
        // Get deadline
        const deadlineElement = document.getElementById('new-task-deadline');
        let deadline = '';
        if (deadlineElement) {
          deadline = deadlineElement.value || '';
        } else {
          console.warn('Deadline element not found, using empty value');
        }
        console.log('Deadline:', deadline);
        
        // Get notes
        const notesElement = document.getElementById('new-task-notes');
        let notes = '';
        if (notesElement) {
          notes = notesElement.value || '';
        } else {
          console.warn('Notes element not found, using empty value');
        }
        
        if (!taskName || taskName.trim() === '') {
          showNotification('Please enter a task name', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        if (!projectName || projectName.trim() === '') {
          showNotification('Please select a project', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        // Find the project card
        console.log("Looking for project with name:", projectName);
        let projectCard = null;
        const projectCards = document.querySelectorAll('.project-card');
        console.log("Total project cards found:", projectCards.length);
        
        // Debug: Print all project titles
        projectCards.forEach(card => {
          const title = card.querySelector('.project-title');
          if (title) {
            console.log("Available project:", title.textContent);
          }
        });
        
        // Look for exact match first
        projectCards.forEach(card => {
          const title = card.querySelector('.project-title');
          if (title && title.textContent.trim() === projectName.trim()) {
            projectCard = card;
            console.log("Found exact match for project:", projectName);
          }
        });
        
        // If no exact match, try case-insensitive match
        if (!projectCard) {
          projectCards.forEach(card => {
            const title = card.querySelector('.project-title');
            if (title && title.textContent.trim().toLowerCase() === projectName.trim().toLowerCase()) {
              projectCard = card;
              console.log("Found case-insensitive match for project:", projectName);
            }
          });
        }
        
        // If still no match, use the first project as fallback
        if (!projectCard && projectCards.length > 0) {
          projectCard = projectCards[0];
          console.log("No matching project found. Using first project as fallback:", 
                      projectCard.querySelector('.project-title').textContent);
        }
        
        console.log('Project card found:', projectCard !== null);
        
        if (!projectCard) {
          showNotification('Project not found. Please create a project first.', 'error');
          document.getElementById('new-task-modal').classList.remove('active');
          isTaskSubmitting = false;
          return false;
        }
        
        // Find the task list
        const taskList = projectCard.querySelector('.task-list');
        console.log('Task list found:', taskList !== null);
        
        if (!taskList) {
          showNotification('Error: Task list not found in the project', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        // Create a new task item
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.id = 'task-' + Date.now(); // Unique ID
        
        // Set priority class name
        const priorityClass = priority + '-priority';
        
        // Create priority icon based on level
        let priorityIcon = '';
        let priorityLabel = 'Medium';
        
        switch(priority) {
          case 'high':
            priorityIcon = 'flag';
            priorityLabel = 'High';
            break;
          case 'medium':
            priorityIcon = 'outlined_flag';
            priorityLabel = 'Medium';
            break;
          case 'low':
            priorityIcon = 'assistant_flag';
            priorityLabel = 'Low';
            break;
        }
        
        // Format deadline if provided
        let deadlineDisplay = '';
        if (deadline) {
          const deadlineDate = new Date(deadline);
          const month = deadlineDate.toLocaleString('default', { month: 'short' });
          const day = deadlineDate.getDate();
          deadlineDisplay = `<span class="task-deadline">${month} ${day}</span>`;
        }
        
        taskItem.innerHTML = `
          <div class="task-checkbox-container">
            <input type="checkbox" id="${taskItem.id}-checkbox" class="task-checkbox">
            <label for="${taskItem.id}-checkbox" class="task-checkbox-label"></label>
          </div>
          <div class="task-content">
            <div class="task-name">${taskName}</div>
            <div class="task-meta">
              <span class="task-priority ${priorityClass}"><i class="material-icons">${priorityIcon}</i>${priorityLabel}</span>
              <span class="task-time">${estTime}h</span>
              ${deadlineDisplay}
            </div>
          </div>
          <div class="task-actions">
            <button class="task-action-btn edit-task-btn"><i class="material-icons">edit</i></button>
            <button class="task-action-btn delete-task-btn"><i class="material-icons">delete</i></button>
          </div>
        `;
        
        // Append the task to the list
        taskList.appendChild(taskItem);
        
        // Add event listener for task checkbox
        const checkbox = taskItem.querySelector('.task-checkbox');
        if (checkbox) {
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              taskItem.classList.add('completed');
              showNotification('Task marked as completed!');
            } else {
              taskItem.classList.remove('completed');
              showNotification('Task marked as not completed');
            }
            
            // Update project progress
            updateProjectProgress(projectCard);
            
            // Save data to localStorage
            saveProjectsData();
          });
        }
        
        // Add event listeners for action buttons
        const editBtn = taskItem.querySelector('.edit-task-btn');
        if (editBtn) {
          editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Task editing functionality
            openEditTaskModal(taskItem);
          });
        }
        
        const deleteBtn = taskItem.querySelector('.delete-task-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const taskName = taskItem.querySelector('.task-name').textContent.trim();
            showConfirmDialog(`Are you sure you want to delete this task "${taskName}"?`, 
              function() {
                // Confirmed - delete task
                taskItem.remove();
                
                // Update project progress
                updateProjectProgress(projectCard);
                
                // Save data to localStorage
                saveProjectsData();
                
                // Show notification
                showNotification(`Task "${taskName}" deleted successfully!`);
              }
            );
          });
        }
        
        // Update project progress
        updateProjectProgress(projectCard);
        
        // Save data to localStorage
        saveProjectsData();
        
        // Close the modal
        document.getElementById('new-task-modal').classList.remove('active');
        
        // Reset the form
        document.getElementById('new-task-form').reset();
        
        // Show notification
        showNotification(`Task "${taskName}" added successfully!`);
        
        return true;
      } finally {
        // Reset after a delay to allow DOM updates to complete
        setTimeout(() => {
          isTaskSubmitting = false;
          console.log('Task submission lock released');
        }, 500);
      }
    }
    
    // Function to populate project dropdown in task form
    function populateProjectDropdown() {
      const projectSelect = document.getElementById('new-task-project');
      if (!projectSelect) return;
      
      // Clear existing options
      projectSelect.innerHTML = '';
      
      // Get all project titles
      const projectTitles = [];
      document.querySelectorAll('.project-card .project-title').forEach(titleElem => {
        projectTitles.push(titleElem.textContent.trim());
      });
      
      console.log("Found projects for dropdown:", projectTitles);
      
      // Add options to select
      projectTitles.forEach(title => {
        const option = document.createElement('option');
        option.text = title;
        option.value = title;
        projectSelect.add(option);
      });
      
      // If no projects, add a default option
      if (projectTitles.length === 0) {
        const option = document.createElement('option');
        option.text = 'No projects available';
        option.value = '';
        option.disabled = true;
        projectSelect.add(option);
      }
    }
    
    // Function to handle clicking the New Project button
    function openNewProjectModal() {
        console.log('Opening New Project modal');
        const modal = document.getElementById('new-project-modal');
        if (modal) {
            modal.classList.add('active');
            // Reset the form
            if (document.getElementById('new-project-form')) {
                document.getElementById('new-project-form').reset();
            }
        } else {
            console.error("New Project modal not found");
        }
    }
    
    // Function to handle clicking the New Task button 
    function openNewTaskModal() {
        console.log('Opening New Task modal');
        const modal = document.getElementById('new-task-modal');
        if (modal) {
            modal.classList.add('active');
            // Reset the form
            if (document.getElementById('new-task-form')) {
                document.getElementById('new-task-form').reset();
            }
            // Refresh project dropdown
            populateProjectDropdown();
        } else {
            console.error("New Task modal not found");
        }
    }
    
    // Initialize all modal functionality when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing modals');
        
        // Initialize project action buttons
        initializeProjectButtons();
        
        // Find New Project button in the header/navbar by various selectors
        const newProjectButtons = [
            ...document.querySelectorAll('.new-project-btn, #new-project-btn, [data-action="new-project"]'),
            ...Array.from(document.querySelectorAll('button, a, .btn, div')).filter(el => 
                el.textContent && el.textContent.trim() === 'New Project'
            )
        ];
        
        console.log('Found New Project buttons:', newProjectButtons.length);
        
        newProjectButtons.forEach(btn => {
            console.log('Adding click handler to New Project button', btn);
            // Remove existing listeners to avoid duplicates
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
                btn.parentNode.replaceChild(newBtn, btn);
            }
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openNewProjectModal();
            });
        });
        
        // Find New Task buttons
        const newTaskButtons = [
            ...document.querySelectorAll('.new-task-btn, #new-task-btn, [data-action="new-task"]'),
            ...Array.from(document.querySelectorAll('button, a, .btn, div')).filter(el => 
                el.textContent && el.textContent.trim() === 'New Task'
            )
        ];
        
        console.log('Found New Task buttons:', newTaskButtons.length);
        
        newTaskButtons.forEach(btn => {
            console.log('Adding click handler to New Task button', btn);
            // Remove existing listeners to avoid duplicates
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
                btn.parentNode.replaceChild(newBtn, btn);
            }
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openNewTaskModal();
            });
        });
        
        // Close buttons for modals
        document.querySelectorAll('.modal-close, .cancel-btn, .modal-overlay .secondary-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Close on overlay click
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(function(modal) {
                    modal.classList.remove('active');
                });
            }
        });
        
        // Save buttons
        const saveNewProjectBtn = document.getElementById('new-project-save');
        if (saveNewProjectBtn) {
            saveNewProjectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save Project button clicked');
                saveNewProject();
            });
        }
        
        const saveNewTaskBtn = document.getElementById('new-task-save');
        if (saveNewTaskBtn) {
            saveNewTaskBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save Task button clicked');
                saveNewTask();
            });
        }
    });
    
    // Add global click event listener as a fallback
    document.addEventListener('click', function(e) {
        // Check if the clicked element or its parents have text "New Project"
        let element = e.target;
        while (element) {
            if (element.textContent && element.textContent.trim() === 'New Project') {
                console.log('Detected click on New Project via global handler');
                openNewProjectModal();
                break;
            }
            element = element.parentElement;
        }
    });
    
    // Update the priority selection in the new task form to show flags
    function updatePriorityDisplay() {
      const newTaskPriorityRadios = document.querySelectorAll('input[name="new-task-priority"]');
      const editTaskPriorityRadios = document.querySelectorAll('input[name="edit-task-priority"]');
      
      // Update display for new task form
      newTaskPriorityRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
          updatePriorityLabels('new-task-priority-display', this.value);
        });
      });
      
      // Update display for edit task form
      editTaskPriorityRadios.forEach(function(radio) {
        radio.addEventListener('change', function() {
          updatePriorityLabels('edit-task-priority-display', this.value);
        });
      });
      
      // Set initial values
      if (document.querySelector('input[name="new-task-priority"]:checked')) {
        updatePriorityLabels('new-task-priority-display', 
                            document.querySelector('input[name="new-task-priority"]:checked').value);
      }
      
      if (document.querySelector('input[name="edit-task-priority"]:checked')) {
        updatePriorityLabels('edit-task-priority-display', 
                            document.querySelector('input[name="edit-task-priority"]:checked').value);
      }
    }
    
    function updatePriorityLabels(displayId, priority) {
      const displayElement = document.getElementById(displayId);
      if (!displayElement) return;
      
      let icon = '';
      let label = '';
      let colorClass = '';
      
      switch(priority) {
        case 'high':
          icon = '🔴';
          label = 'High';
          colorClass = 'high-priority';
          break;
        case 'medium':
          icon = '🟠';
          label = 'Medium';
          colorClass = 'medium-priority';
          break;
        case 'low':
          icon = '🟢';
          label = 'Low';
          colorClass = 'low-priority';
          break;
      }
      
      displayElement.innerHTML = `<span class="${colorClass}">${icon} ${label}</span>`;
    }

    // Function to save a new project
    function saveNewProject() {
      const projectName = document.getElementById('new-project-name').value;
      const projectColor = document.getElementById('new-project-color').value || '#4f46e5';
      const projectDesc = document.getElementById('new-project-desc').value || '';
      
      if (!projectName || projectName.trim() === '') {
        showNotification('Please enter a project name', 'error');
        return false;
      }
      
      // Generate a unique ID for the project
      const projectId = 'project-' + Date.now();
      
      // Create a new project card
      const projectCard = document.createElement('div');
      projectCard.className = 'project-card';
      projectCard.id = projectId;
      projectCard.style.setProperty('--project-color', projectColor);
      
      projectCard.innerHTML = `
        <div class="project-header">
          <div>
            <h3 class="project-title">${projectName}</h3>
            <p class="project-progress">0% complete</p>
            ${projectDesc ? `<p class="project-description">${projectDesc}</p>` : ''}
          </div>
          <div class="task-actions">
            <button class="task-action-btn">
              <span class="material-icons">edit</span>
            </button>
            <button class="task-action-btn">
              <span class="material-icons">delete</span>
            </button>
          </div>
        </div>
        
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%;"></div>
        </div>
        
        <div class="task-list">
          <!-- Tasks will be added here -->
        </div>
        
        <button class="add-task-btn">
          <span class="material-icons">add</span>
          Add Task
        </button>
      `;
      
      // Add the project to the projects grid
      let projectsContainer = document.querySelector('.projects-grid');
      if (!projectsContainer) {
        console.error('Projects container not found. Looking for .projects-container instead...');
        const altContainer = document.querySelector('.projects-container');
        if (!altContainer) {
          console.error('Alternative projects container not found either');
          alert('Error: Could not create project. Please try again.');
          return false;
        }
        console.log('Found .projects-container instead');
        projectsContainer = altContainer;
      }
      
      projectsContainer.appendChild(projectCard);
      console.log('Project card added to DOM');
      
      // Set up "Add Task" button for the new project
      setupAddTaskButtons();
      
      // Refresh the project dropdown in the task form
      populateProjectDropdown();
      
      // Close the modal
      document.getElementById('new-project-modal').classList.remove('active');
      
      // Reset the form
      document.getElementById('new-project-form').reset();
      
      console.log('Project created successfully!');
      return true;
    }

    // Function to set up "Add Task" buttons in project cards
    function setupAddTaskButtons() {
      console.log('Setting up Add Task buttons in project cards');
      document.querySelectorAll('.add-task-btn').forEach(function(btn) {
        // Remove existing listeners to avoid duplicates
        const newBtn = btn.cloneNode(true);
        if (btn.parentNode) {
          btn.parentNode.replaceChild(newBtn, btn);
        }
        
        newBtn.addEventListener('click', function() {
          // Find the project this button belongs to
          const projectCard = this.closest('.project-card');
          if (!projectCard) return;
          
          const projectTitle = projectCard.querySelector('.project-title');
          if (!projectTitle) return;
          
          const projectName = projectTitle.textContent.trim();
          console.log("Add Task clicked for project:", projectName);
          
          // Reset the form
          if (document.getElementById('new-task-form')) {
            document.getElementById('new-task-form').reset();
          }
          
          // Pre-select the project in the dropdown
          const projectSelect = document.getElementById('new-task-project');
          if (projectSelect) {
            let projectFound = false;
            
            for (let i = 0; i < projectSelect.options.length; i++) {
              const optionText = projectSelect.options[i].text.trim();
              
              if (optionText === projectName) {
                projectSelect.selectedIndex = i;
                projectFound = true;
                console.log("Project found in dropdown, selected index:", i);
                break;
              }
            }
            
            // If project not found in dropdown, add it
            if (!projectFound) {
              console.log("Project not found in dropdown, adding it");
              const option = document.createElement('option');
              option.text = projectName;
              option.value = projectName;
              projectSelect.add(option);
              projectSelect.selectedIndex = projectSelect.options.length - 1;
            }
          }
          
          // Show the modal
          openNewTaskModal();
        });
      });
    }
    
    // Ensure setupAddTaskButtons is called when DOM is loaded and after new projects are created
    document.addEventListener('DOMContentLoaded', function() {
      setupAddTaskButtons();
    });
    
    // Hook into saveNewProject to set up Add Task buttons after creating a new project
    const originalSaveNewProject = saveNewProject;
    saveNewProject = function() {
      const result = originalSaveNewProject.apply(this, arguments);
      if (result) {
        setTimeout(setupAddTaskButtons, 100); // Small delay to ensure DOM is updated
      }
      return result;
    };
    
    // Call setupAddTaskButtons when the modal initialization happens
    const originalOpenNewTaskModal = openNewTaskModal;
    openNewTaskModal = function() {
      setupAddTaskButtons();
      return originalOpenNewTaskModal.apply(this, arguments);
    };
    
    // Ensure buttons are properly initialized
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing buttons');
      
      // Find the New Project button in the header
      const newProjectBtn = document.getElementById('new-project-btn');
      if (newProjectBtn) {
        console.log('Found New Project button in header');
        newProjectBtn.addEventListener('click', function(e) {
          console.log('New Project button clicked');
          e.preventDefault();
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            console.log('Opening New Project modal');
            modal.classList.add('active');
            // Reset the form
            if (document.getElementById('new-project-form')) {
              document.getElementById('new-project-form').reset();
            }
          } else {
            console.error('New Project modal not found');
          }
        });
      } else {
        console.error('New Project button not found in the DOM');
      }
      
      // Find the New Task button in the header
      const newTaskBtn = document.getElementById('new-task-btn');
      if (newTaskBtn) {
        console.log('Found New Task button in header');
        newTaskBtn.addEventListener('click', function(e) {
          console.log('New Task button clicked');
          e.preventDefault();
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            console.log('Opening New Task modal');
            modal.classList.add('active');
            // Reset the form
            if (document.getElementById('new-task-form')) {
              document.getElementById('new-task-form').reset();
            }
            // Refresh project dropdown
            populateProjectDropdown();
          } else {
            console.error('New Task modal not found');
          }
        });
      } else {
        console.error('New Task button not found in the DOM');
      }
      
      // ... existing initialization code ...
    });
  </script>

  <!-- Add this script to the end of the file, just before the closing </body> tag -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM fully loaded - setting up New Project button');
      
      // Directly target the New Project button by ID
      const newProjectBtn = document.getElementById('new-project-btn');
      if (newProjectBtn) {
        console.log('Found New Project button:', newProjectBtn);
        
        // Remove any existing click handlers
        const newBtn = newProjectBtn.cloneNode(true);
        if (newProjectBtn.parentNode) {
          newProjectBtn.parentNode.replaceChild(newBtn, newProjectBtn);
        }
        
        // Add a direct click handler
        newBtn.addEventListener('click', function(e) {
          console.log('New Project button clicked!');
          e.preventDefault();
          e.stopPropagation();
          
          // Find and open the modal
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            console.log('Found New Project modal, opening it');
            modal.classList.add('active');
          } else {
            console.error('New Project modal not found in DOM');
          }
        });
      } else {
        console.error('New Project button not found by ID');
        
        // Fallback: Try to find by text content
        const buttons = document.querySelectorAll('button');
        let found = false;
        
        buttons.forEach(function(btn) {
          if (!found && btn.textContent.trim().includes('New Project')) {
            console.log('Found New Project button by text:', btn);
            
            // Add click handler
            btn.addEventListener('click', function(e) {
              console.log('New Project button (found by text) clicked!');
              e.preventDefault();
              e.stopPropagation();
              
              const modal = document.getElementById('new-project-modal');
              if (modal) {
                console.log('Found New Project modal, opening it');
                modal.classList.add('active');
              } else {
                console.error('New Project modal not found in DOM');
              }
            });
            
            found = true;
          }
        });
        
        if (!found) {
          console.error('Could not find New Project button by any method');
        }
      }
      
      // Also ensure New Project modal exists and is properly configured
      const projectModal = document.getElementById('new-project-modal');
      if (!projectModal) {
        console.error('New Project modal not found in the DOM! This is a critical error.');
      } else {
        console.log('New Project modal found in the DOM:', projectModal);
      }
    });
  </script>

  <!-- Add notification and confirmation functionality -->
  <script>
    // Function to show notifications
    function showNotification(message, type = 'success') {
      console.log('Showing notification:', message, type);
      
      // Create or get notification element
      let notification = document.getElementById('notification');
      
      if (!notification) {
        notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = 'notification';
        document.body.appendChild(notification);
        console.log('Created new notification element');
      }
      
      // Set content and type
      notification.className = 'notification';
      if (type === 'error') {
        notification.classList.add('error');
        notification.innerHTML = `<span class="material-icons">error</span> ${message}`;
      } else {
        notification.classList.add('success');
        notification.innerHTML = `<span class="material-icons">check_circle</span> ${message}`;
      }
      
      // Show notification
      setTimeout(() => {
        notification.classList.add('active');
        console.log('Notification activated');
        
        // Hide after 4 seconds
        setTimeout(() => {
          notification.classList.remove('active');
          console.log('Notification hidden');
        }, 4000);
      }, 10);
    }

    // Function to show confirmation dialog
    function showConfirmDialog(message, onConfirm) {
      // Create or get confirm dialog element
      let confirmDialog = document.getElementById('confirm-dialog');
      
      if (!confirmDialog) {
        confirmDialog = document.createElement('div');
        confirmDialog.id = 'confirm-dialog';
        confirmDialog.className = 'confirm-dialog';
        
        confirmDialog.innerHTML = `
          <div class="confirm-dialog-message"></div>
          <div class="confirm-dialog-actions">
            <button class="btn secondary-btn" id="confirm-cancel">Cancel</button>
            <button class="btn primary-btn" id="confirm-ok">Confirm</button>
          </div>
        `;
        
        document.body.appendChild(confirmDialog);
        
        // Add event listeners to the buttons
        document.getElementById('confirm-cancel').addEventListener('click', function() {
          confirmDialog.classList.remove('active');
        });
      }
      
      // Set message
      confirmDialog.querySelector('.confirm-dialog-message').textContent = message;
      
      // Set confirm action
      const okButton = document.getElementById('confirm-ok');
      
      // Remove existing listener to avoid duplicates
      const newOkButton = okButton.cloneNode(true);
      okButton.parentNode.replaceChild(newOkButton, okButton);
      
      newOkButton.addEventListener('click', function() {
        confirmDialog.classList.remove('active');
        if (typeof onConfirm === 'function') {
          onConfirm();
        }
      });
      
      // Show dialog
      confirmDialog.classList.add('active');
    }
  </script>

  <!-- Fix task creation functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Setting up Create Task button event listener');
      
      // Find the Create Task button in the modal using different methods
      let createTaskBtn = document.querySelector('#new-task-modal .primary-btn');
      
      if (!createTaskBtn) {
        createTaskBtn = document.querySelector('.modal-content button.create-task-btn');
      }
      
      if (!createTaskBtn) {
        // Find by text content
        const buttons = document.querySelectorAll('.modal-content button');
        for (let i = 0; i < buttons.length; i++) {
          if (buttons[i].textContent.trim() === 'Create Task') {
            createTaskBtn = buttons[i];
            break;
          }
        }
      }
      
      // Also try to find it by ID
      if (!createTaskBtn) {
        createTaskBtn = document.getElementById('create-task-btn');
      }
      
      if (createTaskBtn) {
        console.log('Found Create Task button:', createTaskBtn);
        
        // Remove any existing click handlers to avoid duplicates
        const newCreateTaskBtn = createTaskBtn.cloneNode(true);
        if (createTaskBtn.parentNode) {
          createTaskBtn.parentNode.replaceChild(newCreateTaskBtn, createTaskBtn);
        }
        
        // Add direct click handler
        newCreateTaskBtn.addEventListener('click', function(e) {
          console.log('Create Task button clicked!');
          e.preventDefault();
          
          // Call saveNewTask function
          const result = saveNewTask();
          console.log('saveNewTask result:', result);
        });
      } else {
        console.error('Create Task button not found in the modal');
        
        // Try to set up an event listener on the form instead
        const taskForm = document.getElementById('new-task-form');
        if (taskForm) {
          console.log('Found task form, setting up submit event');
          taskForm.addEventListener('submit', function(e) {
            console.log('Task form submitted');
            e.preventDefault();
            const result = saveNewTask();
            console.log('saveNewTask result from form submit:', result);
          });
        }
      }
    });
  </script>

  <!-- Add data persistence functionality -->
  <script>
    // Save projects data to localStorage
    function saveProjectsData() {
      console.log('Saving projects data to localStorage');
      
      // Get all project cards from the DOM
      const projectCards = document.querySelectorAll('.project-card');
      const projects = [];
      
      // Extract data from each project
      projectCards.forEach(card => {
        try {
          const projectTitleElem = card.querySelector('.project-title');
          const projectProgressElem = card.querySelector('.project-progress');
          const progressValueElem = card.querySelector('.progress-fill');
          
          // Skip if essential elements are missing
          if (!projectTitleElem || !projectProgressElem || !progressValueElem) {
            console.warn('Skipping project due to missing elements', card.id);
            return;
          }
          
          const projectTitle = projectTitleElem.textContent;
          const projectProgress = projectProgressElem.textContent;
          const progressValue = progressValueElem.style.width || '0%';
          const projectColor = card.style.getPropertyValue('--project-color') || 
                              window.getComputedStyle(card).getPropertyValue('--project-color') || 
                              '#4f46e5';
          
          // Get all tasks for this project
          const taskItems = card.querySelectorAll('.task-item');
          const tasks = [];
          
          taskItems.forEach(taskItem => {
            try {
              const taskNameElem = taskItem.querySelector('.task-name');
              const taskCheckboxElem = taskItem.querySelector('.task-checkbox');
              
              // Skip if essential elements are missing
              if (!taskNameElem || !taskCheckboxElem) {
                console.warn('Skipping task due to missing elements');
                return;
              }
              
              const taskName = taskNameElem.textContent;
              const isCompleted = taskCheckboxElem.checked;
              
              // Get priority
              let priority = 'medium';
              const priorityElem = taskItem.querySelector('.task-priority');
              if (priorityElem) {
                if (priorityElem.classList.contains('high-priority')) priority = 'high';
                else if (priorityElem.classList.contains('low-priority')) priority = 'low';
              }
              
              // Get estimated time
              let estTime = '1';
              const timeElem = taskItem.querySelector('.task-time');
              if (timeElem) {
                estTime = timeElem.textContent || '1';
              }
              
              // Get deadline
              let deadline = '';
              const deadlineElem = taskItem.querySelector('.task-deadline');
              if (deadlineElem) {
                deadline = deadlineElem.textContent || '';
              }
              
              tasks.push({
                name: taskName,
                completed: isCompleted,
                priority: priority,
                estTime: estTime,
                deadline: deadline
              });
            } catch (taskError) {
              console.error('Error processing task:', taskError);
            }
          });
          
          projects.push({
            title: projectTitle,
            progress: projectProgress,
            progressValue: progressValue,
            color: projectColor,
            tasks: tasks
          });
        } catch (projectError) {
          console.error('Error processing project:', projectError);
        }
      });
      
      // Save to localStorage
      localStorage.setItem('tempus-projects', JSON.stringify(projects));
      console.log('Saved projects data to localStorage:', projects);
    }

    function loadProjectsData() {
      const projectsData = localStorage.getItem('tempus-projects');
      if (!projectsData) {
        console.log('No saved projects found');
        return;
      }
      
      try {
        const projects = JSON.parse(projectsData);
        console.log('Loaded projects data:', projects.length, 'projects');
        
        // Clear existing projects
        const projectsContainer = document.querySelector('.projects-grid') || document.querySelector('.projects-container');
        if (!projectsContainer) {
          console.error('Projects container not found');
          return;
        }
        
        // Remove existing project cards if any
        projectsContainer.innerHTML = '';
        
        // Create each project
        projects.forEach(project => {
          const newProjectCard = document.createElement('div');
          newProjectCard.className = 'project-card';
          newProjectCard.style.borderTopColor = project.color;
          newProjectCard.style.borderTopWidth = '4px';
          
          // Calculate numeric percentage
          let completion = '0';
          if (project.progressValue) {
            completion = project.progressValue.replace('%', '');
          }
          
          newProjectCard.innerHTML = `
            <div class="project-header">
              <div class="project-title">${project.title}</div>
              <div class="project-actions">
                <button class="project-action-btn edit-project-btn"><i class="material-icons">edit</i></button>
                <button class="project-action-btn"><i class="material-icons">more_vert</i></button>
              </div>
            </div>
            <div class="project-progress">${project.progress || '0% complete'}</div>
            <div class="progress-bar">
              <div class="progress-value" style="width: ${completion}%"></div>
            </div>
            <div class="task-list"></div>
            <div class="add-task-container">
              <button class="add-task-btn">
                <i class="material-icons">add</i> Add Task
              </button>
            </div>
          `;
          
          // Add project to container
          projectsContainer.appendChild(newProjectCard);
          
          // Add tasks to project
          const taskList = newProjectCard.querySelector('.task-list');
          
          project.tasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-item';
            if (task.completed) {
              taskItem.classList.add('completed');
            }
            
            const taskId = 'task-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            // Determine priority class and icon
            let priorityClass = task.priority + '-priority';
            let priorityIcon = 'outlined_flag';
            let priorityLabel = 'Medium';
            
            switch(task.priority) {
              case 'high':
                priorityIcon = 'flag';
                priorityLabel = 'High';
                break;
              case 'low':
                priorityIcon = 'assistant_flag';
                priorityLabel = 'Low';
                break;
            }
            
            taskItem.innerHTML = `
              <div class="task-checkbox-container">
                <input type="checkbox" id="${taskId}-checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                <label for="${taskId}-checkbox" class="task-checkbox-label"></label>
              </div>
              <div class="task-content">
                <div class="task-name">${task.name}</div>
                <div class="task-meta">
                  <span class="task-priority ${priorityClass}"><i class="material-icons">${priorityIcon}</i>${priorityLabel}</span>
                  <span class="task-time">${task.estTime}h</span>
                  ${task.deadline ? `<span class="task-deadline">${task.deadline}</span>` : ''}
                </div>
              </div>
              <div class="task-actions">
                <button class="task-action-btn edit-task-btn"><i class="material-icons">edit</i></button>
                <button class="task-action-btn delete-task-btn"><i class="material-icons">delete</i></button>
              </div>
            `;
            
            taskList.appendChild(taskItem);
          });
        });
        
        // Set up Add Task buttons and reattach event listeners
        setupAddTaskButtons();
        attachTaskEventListeners();
        
        // Refresh project dropdown
        populateProjectDropdown();
        
      } catch (error) {
        console.error('Error loading projects data:', error);
        return null;
      }
    }
    
    // Function to attach event listeners to all task items
    function attachTaskEventListeners() {
      // Add event listeners for checkboxes
      document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const taskItem = this.closest('.task-item');
          const projectCard = this.closest('.project-card');
          
          if (this.checked) {
            taskItem.classList.add('completed');
          } else {
            taskItem.classList.remove('completed');
          }
          
          // Update project progress
          updateProjectProgress(projectCard);
          // Save updated data
          saveProjectsData();
        });
      });
      
      // Add event listeners for delete buttons
      document.querySelectorAll('.delete-task-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const taskItem = this.closest('.task-item');
          const projectCard = this.closest('.project-card');
          
          if (confirm('Are you sure you want to delete this task?')) {
            taskItem.remove();
            // Update project progress
            updateProjectProgress(projectCard);
            // Save updated data
            saveProjectsData();
          }
        });
      });
      
      // Add event listeners for edit buttons
      document.querySelectorAll('.edit-task-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
          e.preventDefault();
          const taskItem = this.closest('.task-item');
          // Add task editing functionality here
          console.log('Edit task:', taskItem.querySelector('.task-name').textContent);
        });
      });
    }

    // Hook into existing functions to save data after changes
    if (typeof persistenceHooksInitialized === 'undefined') {
      // Store original functions
      const origSaveNewProject = saveNewProject;
      const origSaveNewTask = saveNewTask;
      const origUpdateProjectProgress = updateProjectProgress;
      
      // Override with persistence hooks
      saveNewProject = function() {
        const result = origSaveNewProject.apply(this, arguments);
        if (result) {
          // Save data after project is created
          setTimeout(saveProjectsData, 100); // Small delay to ensure DOM is updated
        }
        return result;
      };

      saveNewTask = function() {
        const result = origSaveNewTask.apply(this, arguments);
        if (result) {
          // Save data after task is created
          setTimeout(saveProjectsData, 100); // Small delay to ensure DOM is updated
        }
        return result;
      };

      updateProjectProgress = function(projectCard) {
        const result = origUpdateProjectProgress.apply(this, arguments);
        // Save data after progress is updated
        setTimeout(saveProjectsData, 100); // Small delay to ensure DOM is updated
        return result;
      };
      
      // Mark as initialized to prevent double initialization
      window.persistenceHooksInitialized = true;
    }

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, loading saved projects data');
      setTimeout(loadProjectsData, 200); // Small delay to ensure other initializations complete first
    });
  </script>

  <!-- Add direct event handlers for the Create Task button -->
  <script>
    // Debounce function to prevent multiple rapid executions
    function debounce(func, wait) {
      let timeout;
      return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), wait);
      };
    }

    // Initialize task submission lock
    let isTaskSubmitting = false;
    
    // Function to save a new task
    function saveNewTask() {
      // Prevent multiple submissions
      if (isTaskSubmitting) {
        console.log('Task submission already in progress, ignoring duplicate call');
        return false;
      }
      
      try {
        console.log('saveNewTask called');
        isTaskSubmitting = true;
        
        // Check if the modal is visible
        const modal = document.getElementById('new-task-modal');
        console.log('Modal exists:', !!modal);
        console.log('Modal visible:', modal && modal.classList.contains('active'));
        
        // Log all form elements before trying to access them
        console.log('Form exists:', !!document.getElementById('new-task-form'));
        console.log('Name input exists:', !!document.getElementById('new-task-name'));
        console.log('Project select exists:', !!document.getElementById('new-task-project'));
        console.log('Time input exists:', !!document.getElementById('new-task-time'));
        
        // Get form values
        const taskNameElement = document.getElementById('new-task-name');
        if (!taskNameElement) {
          console.error('Task name element not found!');
          showNotification('Error: Task name field not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        const taskName = taskNameElement.value;
        console.log('Task name:', taskName);
        
        const projectSelect = document.getElementById('new-task-project');
        if (!projectSelect) {
          console.error('Project select element not found!');
          showNotification('Error: Project select field not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        console.log('Project select element found:', projectSelect);
        
        let projectName = '';
        
        // Check if there are options in the select
        if (projectSelect && projectSelect.options.length > 0) {
          const selectedIndex = projectSelect.selectedIndex;
          if (selectedIndex >= 0) {
            projectName = projectSelect.options[selectedIndex].text;
          }
        }
        
        console.log("Selected project:", projectName);
        
        // Check if priority radio buttons exist and at least one is checked
        const priorityRadios = document.querySelectorAll('input[name="new-task-priority"]');
        if (priorityRadios.length === 0) {
          console.error('Priority radio buttons not found!');
          showNotification('Error: Priority selection not found.', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        let priority = 'medium'; // Default value
        const checkedPriority = document.querySelector('input[name="new-task-priority"]:checked');
        if (checkedPriority) {
          priority = checkedPriority.value;
        } else {
          console.warn('No priority selected, using default: medium');
        }
        console.log('Priority:', priority);
        
        // Get estimated time
        const timeElement = document.getElementById('new-task-time');
        let estTime = '1'; // Default value
        if (timeElement) {
          estTime = timeElement.value || '1';
        } else {
          console.warn('Time element not found, using default: 1');
        }
        console.log('Estimated time:', estTime);
        
        // Get deadline
        const deadlineElement = document.getElementById('new-task-deadline');
        let deadline = '';
        if (deadlineElement) {
          deadline = deadlineElement.value || '';
        } else {
          console.warn('Deadline element not found, using empty value');
        }
        console.log('Deadline:', deadline);
        
        // Get notes
        const notesElement = document.getElementById('new-task-notes');
        let notes = '';
        if (notesElement) {
          notes = notesElement.value || '';
        } else {
          console.warn('Notes element not found, using empty value');
        }
        
        if (!taskName || taskName.trim() === '') {
          showNotification('Please enter a task name', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        if (!projectName || projectName.trim() === '') {
          showNotification('Please select a project', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        // Find the project card
        console.log("Looking for project with name:", projectName);
        let projectCard = null;
        const projectCards = document.querySelectorAll('.project-card');
        console.log("Total project cards found:", projectCards.length);
        
        // Debug: Print all project titles
        projectCards.forEach(card => {
          const title = card.querySelector('.project-title');
          if (title) {
            console.log("Available project:", title.textContent);
          }
        });
        
        // Look for exact match first
        projectCards.forEach(card => {
          const title = card.querySelector('.project-title');
          if (title && title.textContent.trim() === projectName.trim()) {
            projectCard = card;
            console.log("Found exact match for project:", projectName);
          }
        });
        
        // If no exact match, try case-insensitive match
        if (!projectCard) {
          projectCards.forEach(card => {
            const title = card.querySelector('.project-title');
            if (title && title.textContent.trim().toLowerCase() === projectName.trim().toLowerCase()) {
              projectCard = card;
              console.log("Found case-insensitive match for project:", projectName);
            }
          });
        }
        
        // If still no match, use the first project as fallback
        if (!projectCard && projectCards.length > 0) {
          projectCard = projectCards[0];
          console.log("No matching project found. Using first project as fallback:", 
                      projectCard.querySelector('.project-title').textContent);
        }
        
        console.log('Project card found:', projectCard !== null);
        
        if (!projectCard) {
          showNotification('Project not found. Please create a project first.', 'error');
          document.getElementById('new-task-modal').classList.remove('active');
          isTaskSubmitting = false;
          return false;
        }
        
        // Find the task list
        const taskList = projectCard.querySelector('.task-list');
        console.log('Task list found:', taskList !== null);
        
        if (!taskList) {
          showNotification('Error: Task list not found in the project', 'error');
          isTaskSubmitting = false;
          return false;
        }
        
        // Create a new task item
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.id = 'task-' + Date.now(); // Unique ID
        
        // Set priority class name
        const priorityClass = priority + '-priority';
        
        // Create priority icon based on level
        let priorityIcon = '';
        let priorityLabel = 'Medium';
        
        switch(priority) {
          case 'high':
            priorityIcon = 'flag';
            priorityLabel = 'High';
            break;
          case 'medium':
            priorityIcon = 'outlined_flag';
            priorityLabel = 'Medium';
            break;
          case 'low':
            priorityIcon = 'assistant_flag';
            priorityLabel = 'Low';
            break;
        }
        
        // Format deadline if provided
        let deadlineDisplay = '';
        if (deadline) {
          const deadlineDate = new Date(deadline);
          const month = deadlineDate.toLocaleString('default', { month: 'short' });
          const day = deadlineDate.getDate();
          deadlineDisplay = `<span class="task-deadline">${month} ${day}</span>`;
        }
        
        taskItem.innerHTML = `
          <div class="task-checkbox-container">
            <input type="checkbox" id="${taskItem.id}-checkbox" class="task-checkbox">
            <label for="${taskItem.id}-checkbox" class="task-checkbox-label"></label>
          </div>
          <div class="task-content">
            <div class="task-name">${taskName}</div>
            <div class="task-meta">
              <span class="task-priority ${priorityClass}"><i class="material-icons">${priorityIcon}</i>${priorityLabel}</span>
              <span class="task-time">${estTime}h</span>
              ${deadlineDisplay}
            </div>
          </div>
          <div class="task-actions">
            <button class="task-action-btn edit-task-btn"><i class="material-icons">edit</i></button>
            <button class="task-action-btn delete-task-btn"><i class="material-icons">delete</i></button>
          </div>
        `;
        
        // Append the task to the list
        taskList.appendChild(taskItem);
        
        // Add event listener for task checkbox
        const checkbox = taskItem.querySelector('.task-checkbox');
        if (checkbox) {
          checkbox.addEventListener('change', function() {
            if (this.checked) {
              taskItem.classList.add('completed');
              showNotification('Task marked as completed!');
            } else {
              taskItem.classList.remove('completed');
              showNotification('Task marked as not completed');
            }
            
            // Update project progress
            updateProjectProgress(projectCard);
            
            // Save data to localStorage
            saveProjectsData();
          });
        }
        
        // Add event listeners for action buttons
        const editBtn = taskItem.querySelector('.edit-task-btn');
        if (editBtn) {
          editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            // Task editing functionality
            openEditTaskModal(taskItem);
          });
        }
        
        const deleteBtn = taskItem.querySelector('.delete-task-btn');
        if (deleteBtn) {
          deleteBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const taskName = taskItem.querySelector('.task-name').textContent.trim();
            showConfirmDialog(`Are you sure you want to delete this task "${taskName}"?`, 
              function() {
                // Confirmed - delete task
                taskItem.remove();
                
                // Update project progress
                updateProjectProgress(projectCard);
                
                // Save data to localStorage
                saveProjectsData();
                
                // Show notification
                showNotification(`Task "${taskName}" deleted successfully!`);
              }
            );
          });
        }
        
        // Update project progress
        updateProjectProgress(projectCard);
        
        // Save data to localStorage
        saveProjectsData();
        
        // Close the modal
        document.getElementById('new-task-modal').classList.remove('active');
        
        // Reset the form
        document.getElementById('new-task-form').reset();
        
        // Show notification
        showNotification(`Task "${taskName}" added successfully!`);
        
        return true;
      } finally {
        // Reset after a delay to allow DOM updates to complete
        setTimeout(() => {
          isTaskSubmitting = false;
          console.log('Task submission lock released');
        }, 500);
      }
    }
    
    // Wait for page load
    window.addEventListener('load', function() {
      console.log('Window loaded - setting up direct event handlers');
      
      // Set up direct event handler for the Create Task button
      const createTaskBtn = document.getElementById('create-task-btn');
      if (createTaskBtn) {
        console.log('Found Create Task button with ID');
        
        // Remove any existing listeners and replace with our debounced version
        const newBtn = createTaskBtn.cloneNode(true);
        if (createTaskBtn.parentNode) {
          createTaskBtn.parentNode.replaceChild(newBtn, createTaskBtn);
        }
        
        newBtn.onclick = function(e) {
          console.log('Create Task button clicked');
          e.preventDefault();
          saveNewTask();
        };
      } else {
        console.error('Create Task button not found!');
      }
    });
  </script>

  <!-- Function to open the new task modal and set up the form -->
  <script>
    function openNewTaskModal(selectedProject = null) {
      console.log('Opening new task modal with project:', selectedProject);
      
      // First, populate the project dropdown
      populateProjectDropdown();
      
      // Reset form
      const taskForm = document.getElementById('new-task-form');
      if (taskForm) {
        console.log('Resetting task form');
        taskForm.reset();
      } else {
        console.error('Task form not found!');
      }
      
      // Pre-select project if provided
      if (selectedProject) {
        const projectSelect = document.getElementById('new-task-project');
        if (projectSelect && projectSelect.options.length > 0) {
          console.log('Selecting project in dropdown:', selectedProject);
          for (let i = 0; i < projectSelect.options.length; i++) {
            if (projectSelect.options[i].text === selectedProject) {
              projectSelect.selectedIndex = i;
              break;
            }
          }
        }
      }
      
      // Show modal
      const modal = document.getElementById('new-task-modal');
      if (modal) {
        console.log('Showing new task modal');
        modal.classList.add('active');
      } else {
        console.error('New task modal not found!');
      }
    }

    // Set up event listeners when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM fully loaded - setting up event listeners');
      
      // New Task button in header
      const newTaskBtn = document.getElementById('new-task-btn');
      if (newTaskBtn) {
        console.log('Adding click handler to New Task button');
        newTaskBtn.addEventListener('click', function() {
          openNewTaskModal();
        });
      }
      
      // Add Task buttons in project cards
      document.querySelectorAll('.add-task-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          // Find the project this button belongs to
          const projectCard = this.closest('.project-card');
          if (!projectCard) return;
          
          const projectTitle = projectCard.querySelector('.project-title');
          if (!projectTitle) return;
          
          const projectName = projectTitle.textContent.trim();
          console.log('Add Task clicked for project:', projectName);
          
          openNewTaskModal(projectName);
        });
      });
      
      // Create Task button in modal
      const createTaskBtn = document.getElementById('create-task-btn');
      if (createTaskBtn) {
        console.log('Setting up Create Task button click handler');
        // Remove previous event listeners to prevent duplicates
        const oldBtn = createTaskBtn.cloneNode(true);
        createTaskBtn.parentNode.replaceChild(oldBtn, createTaskBtn);
        
        // Add new event listener with debounce
        const debouncedSaveNewTask = debounce(function(e) {
          if (e) e.preventDefault();
          saveNewTask();
        }, 300); // 300ms debounce time
        
        oldBtn.addEventListener('click', debouncedSaveNewTask);
      } else {
        console.error('Create Task button not found!');
      }
      
      // Close buttons for modals
      const closeTaskModal = document.getElementById('new-task-close');
      if (closeTaskModal) {
        closeTaskModal.addEventListener('click', function() {
          document.getElementById('new-task-modal').classList.remove('active');
        });
      }
      
      const cancelBtns = document.querySelectorAll('.cancel-modal-btn');
      cancelBtns.forEach(function(btn) {
        btn.addEventListener('click', function() {
          const modal = this.closest('.modal-overlay');
          if (modal) modal.classList.remove('active');
        });
      });
    });
  </script>

  <!-- Function to delete a project card -->
  <script>
    // Function to delete a project card
    function deleteProject(projectId) {
      const projectCard = document.getElementById(projectId);
      if (!projectCard) {
        console.error('Project card not found:', projectId);
        return;
      }
      
      const projectTitle = projectCard.querySelector('.project-title');
      if (!projectTitle) {
        console.error('Project title not found in project card');
        return;
      }
      
      const projectName = projectTitle.textContent.trim();
      
      // Show confirmation dialog
      showConfirmDialog(`Are you sure you want to delete project "${projectName}" and all its tasks?`,
        function() {
          // Remove the project card from the DOM
          projectCard.remove();
          
          // Save data to localStorage
          saveProjectsData();
          
          // Show notification
          showNotification(`Project "${projectName}" deleted successfully!`);
        }
      );
    }
    
    // Function to initialize project card action buttons
    function initializeProjectButtons() {
      console.log('Initializing project action buttons');
      
      // Add project action buttons
      document.querySelectorAll('.project-header .task-actions').forEach(actionsContainer => {
        // Clear existing buttons
        actionsContainer.innerHTML = '';
        
        // Add Edit button
        const editBtn = document.createElement('button');
        editBtn.className = 'task-action-btn';
        editBtn.innerHTML = '<span class="material-icons">edit</span>';
        editBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const projectCard = this.closest('.project-card');
          // Edit project functionality (to be implemented)
          console.log('Edit project clicked:', projectCard.id);
        });
        actionsContainer.appendChild(editBtn);
        
        // Add Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'task-action-btn';
        deleteBtn.innerHTML = '<span class="material-icons">delete</span>';
        deleteBtn.addEventListener('click', function(e) {
          e.preventDefault();
          const projectCard = this.closest('.project-card');
          if (projectCard) {
            deleteProject(projectCard.id);
          }
        });
        actionsContainer.appendChild(deleteBtn);
      });
    }
    
    // Initialize all modal functionality when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing modals');
        
        // Initialize project action buttons
        initializeProjectButtons();
        
        // Find New Project button in the header/navbar by various selectors
        const newProjectButtons = [
            ...document.querySelectorAll('.new-project-btn, #new-project-btn, [data-action="new-project"]'),
            ...Array.from(document.querySelectorAll('button, a, .btn, div')).filter(el => 
                el.textContent && el.textContent.trim() === 'New Project'
            )
        ];
        
        console.log('Found New Project buttons:', newProjectButtons.length);
        
        newProjectButtons.forEach(btn => {
            console.log('Adding click handler to New Project button', btn);
            // Remove existing listeners to avoid duplicates
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
                btn.parentNode.replaceChild(newBtn, btn);
            }
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openNewProjectModal();
            });
        });
        
        // Find New Task buttons
        const newTaskButtons = [
            ...document.querySelectorAll('.new-task-btn, #new-task-btn, [data-action="new-task"]'),
            ...Array.from(document.querySelectorAll('button, a, .btn, div')).filter(el => 
                el.textContent && el.textContent.trim() === 'New Task'
            )
        ];
        
        console.log('Found New Task buttons:', newTaskButtons.length);
        
        newTaskButtons.forEach(btn => {
            console.log('Adding click handler to New Task button', btn);
            // Remove existing listeners to avoid duplicates
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
                btn.parentNode.replaceChild(newBtn, btn);
            }
            
            newBtn.addEventListener('click', function(e) {
                e.preventDefault();
                openNewTaskModal();
            });
        });
        
        // Close buttons for modals
        document.querySelectorAll('.modal-close, .cancel-btn, .modal-overlay .secondary-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                const modal = this.closest('.modal-overlay');
                if (modal) {
                    modal.classList.remove('active');
                }
            });
        });
        
        // Close on overlay click
        document.querySelectorAll('.modal-overlay').forEach(function(overlay) {
            overlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });
        
        // Close on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(function(modal) {
                    modal.classList.remove('active');
                });
            }
        });
        
        // Save buttons
        const saveNewProjectBtn = document.getElementById('new-project-save');
        if (saveNewProjectBtn) {
            saveNewProjectBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save Project button clicked');
                saveNewProject();
            });
        }
        
        const saveNewTaskBtn = document.getElementById('new-task-save');
        if (saveNewTaskBtn) {
            saveNewTaskBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('Save Task button clicked');
                saveNewTask();
            });
        }
    });
  </script>

  <!-- Script to ensure delete functionality works on page load -->
  <script>
    // This function sets up the delete functionality for tasks and projects
    function setupDeleteFunctionality() {
      console.log('Setting up delete functionality');

      // Setup project deletion
      document.querySelectorAll('.project-card').forEach(projectCard => {
        const actionContainer = projectCard.querySelector('.project-header .task-actions');
        if (actionContainer) {
          // Make sure delete button exists
          let deleteBtn = actionContainer.querySelector('.delete-project-btn');
          if (!deleteBtn) {
            deleteBtn = document.createElement('button');
            deleteBtn.className = 'task-action-btn delete-project-btn';
            deleteBtn.innerHTML = '<span class="material-icons">delete</span>';
            actionContainer.appendChild(deleteBtn);
          }
          
          // Set up event listener
          deleteBtn.onclick = function(e) {
            e.preventDefault();
            const projectName = projectCard.querySelector('.project-title')?.textContent.trim() || 'this project';
            if (confirm(`Are you sure you want to delete "${projectName}" and all its tasks?`)) {
              projectCard.remove();
              saveProjectsData();
              alert(`Project "${projectName}" deleted successfully`);
            }
          };
        }
      });
      
      // Setup task deletion
      document.querySelectorAll('.task-item').forEach(taskItem => {
        const actionContainer = taskItem.querySelector('.task-actions');
        if (actionContainer) {
          // Make sure delete button exists
          let deleteBtn = actionContainer.querySelector('.delete-task-btn');
          if (!deleteBtn) {
            deleteBtn = document.createElement('button');
            deleteBtn.className = 'task-action-btn delete-task-btn';
            deleteBtn.innerHTML = '<span class="material-icons">delete</span>';
            actionContainer.appendChild(deleteBtn);
          }
          
          // Set up event listener
          deleteBtn.onclick = function(e) {
            e.preventDefault();
            const taskName = taskItem.querySelector('.task-name')?.textContent.trim() || 'this task';
            if (confirm(`Are you sure you want to delete "${taskName}"?`)) {
              taskItem.remove();
              // Update project progress
              const projectCard = taskItem.closest('.project-card');
              if (projectCard) {
                updateProjectProgress(projectCard);
              }
              saveProjectsData();
              alert(`Task "${taskName}" deleted successfully`);
            }
          };
        }
      });
    }
    
    // Run when DOM is ready
    document.addEventListener('DOMContentLoaded', setupDeleteFunctionality);
    
    // Also run when projects are loaded or modified
    document.addEventListener('projectsUpdated', setupDeleteFunctionality);
  </script>

  <!-- Script to implement project options menu -->
  <script>
    // Function to set up the more options menu for projects
    function setupProjectOptionsMenu() {
      console.log('Setting up project options menus');
      
      // For each project card
      document.querySelectorAll('.project-card').forEach(projectCard => {
        const projectHeader = projectCard.querySelector('.project-header');
        const moreOptionsBtn = projectHeader.querySelector('.task-action-btn:not(.edit-project-btn):not(.delete-project-btn)');
        
        if (moreOptionsBtn) {
          // Check if it has the more_vert icon
          const iconElement = moreOptionsBtn.querySelector('.material-icons');
          if (iconElement && iconElement.textContent === 'more_vert') {
            console.log('Found more options button in project header');
            
            // Create a dropdown menu if it doesn't exist
            let dropdownMenu = projectHeader.querySelector('.dropdown-menu');
            if (!dropdownMenu) {
              dropdownMenu = document.createElement('div');
              dropdownMenu.className = 'dropdown-menu';
              dropdownMenu.innerHTML = `
                <div class="dropdown-item edit-project">
                  <span class="material-icons">edit</span>
                  Edit Project
                </div>
                <div class="dropdown-item delete-project">
                  <span class="material-icons">delete</span>
                  Delete Project
                </div>
              `;
              projectHeader.appendChild(dropdownMenu);
              
              // Set up event listeners for dropdown items
              dropdownMenu.querySelector('.edit-project').addEventListener('click', function(e) {
                e.stopPropagation();
                const projectTitle = projectCard.querySelector('.project-title').textContent;
                console.log('Edit project clicked:', projectTitle);
                // Here you would open the edit project modal
                alert(`Edit project functionality for "${projectTitle}" will be implemented soon.`);
                dropdownMenu.classList.remove('active');
              });
              
              dropdownMenu.querySelector('.delete-project').addEventListener('click', function(e) {
                e.stopPropagation();
                const projectTitle = projectCard.querySelector('.project-title').textContent;
                console.log('Delete project clicked:', projectTitle);
                
                if (confirm(`Are you sure you want to delete project "${projectTitle}" and all its tasks?`)) {
                  console.log('Deleting project:', projectTitle);
                  projectCard.remove();
                  
                  // Save data to localStorage
                  try {
                    saveProjectsData();
                  } catch (err) {
                    console.error('Error saving data after project deletion:', err);
                  }
                  
                  alert(`Project "${projectTitle}" deleted successfully!`);
                }
                
                dropdownMenu.classList.remove('active');
              });
            }
            
            // Toggle dropdown on button click
            moreOptionsBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              dropdownMenu.classList.toggle('active');
            });
            
            // Close dropdown when clicking elsewhere
            document.addEventListener('click', function() {
              dropdownMenu.classList.remove('active');
            });
          }
        }
      });
    }
    
    // Execute when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
      setupProjectOptionsMenu();
    });
    
    // Also run when window is loaded
    window.addEventListener('load', function() {
      setupProjectOptionsMenu();
    });
    
    // Run now if DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      setupProjectOptionsMenu();
    }
  </script>

  <!-- Updated script for edit project functionality -->
  <script>
    // Function to handle the project editing - simplified to avoid conflicts
    function setupProjectEdit() {
      console.log('Setting up additional project edit functionality');
      // We'll keep any existing functionality that doesn't conflict with our new modal
    }
    
    // Call this function to set up project editing
    document.addEventListener('DOMContentLoaded', setupProjectEdit);
  </script>

  <!-- Script to add unique IDs to project cards -->
  <script>
    // Function to assign unique IDs to all project cards
    function assignProjectIds() {
      console.log('Assigning IDs to project cards');
      
      document.querySelectorAll('.project-card').forEach((projectCard, index) => {
        if (!projectCard.hasAttribute('data-project-id')) {
          const projectId = `project-${Date.now()}-${index}`;
          projectCard.setAttribute('data-project-id', projectId);
          console.log(`Assigned ID ${projectId} to project card`);
        }
      });
    }
    
    // Function to improve the New Project modal with color picker
    function enhanceNewProjectModal() {
      const newProjectModal = document.getElementById('new-project-modal');
      
      if (!newProjectModal) {
        console.log('Creating new project modal');
        
        // Create the new project modal
        const modalHTML = `
          <div id="new-project-modal" class="modal">
            <div class="modal-content">
              <div class="modal-header">
                <h3>Create New Project</h3>
                <span class="close-modal">&times;</span>
              </div>
              <div class="modal-body">
                <form id="new-project-form">
                  <div class="form-group">
                    <label for="new-project-name">Project Name</label>
                    <input type="text" id="new-project-name" required>
                  </div>
                  <div class="form-group">
                    <label for="new-project-color">Project Color</label>
                    <div class="color-selector">
                      <input type="color" id="new-project-color" value="#4f46e5">
                      <div class="color-presets">
                        <div class="color-preset active" data-color="#4f46e5" style="background-color: #4f46e5;"></div>
                        <div class="color-preset" data-color="#10b981" style="background-color: #10b981;"></div>
                        <div class="color-preset" data-color="#f59e0b" style="background-color: #f59e0b;"></div>
                        <div class="color-preset" data-color="#ef4444" style="background-color: #ef4444;"></div>
                        <div class="color-preset" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
                      </div>
                    </div>
                  </div>
                  <div class="form-actions">
                    <button type="button" class="btn secondary-btn close-modal">Cancel</button>
                    <button type="button" id="create-project-btn" class="btn primary-btn">Create Project</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;
        
        // Append the modal to the body
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
        // Get the new modal
        const modal = document.getElementById('new-project-modal');
        const form = document.getElementById('new-project-form');
        
        // Add event listeners
        modal.querySelectorAll('.close-modal').forEach(btn => {
          btn.addEventListener('click', function() {
            modal.classList.remove('active');
          });
        });
        
        // Handle form submission
        form.addEventListener('submit', function(e) {
          e.preventDefault();
          
          const projectName = document.getElementById('new-project-name').value;
          const projectColor = document.getElementById('new-project-color').value;
          
          if (!projectName.trim()) {
            alert('Project name cannot be empty');
            return;
          }
          
          // Create new project
          createNewProject(projectName, projectColor);
          
          // Reset form and close modal
          form.reset();
          modal.classList.remove('active');
        });
      }
    }
    
    // Function to create a new project
    function createNewProject(name, color) {
      const projectsContainer = document.querySelector('.projects-container');
      
      if (!projectsContainer) {
        console.error('Projects container not found');
        return;
      }
      
      const projectId = `project-${Date.now()}`;
      
      // Create project HTML
      const projectHTML = `
        <div class="project-card" data-project-id="${projectId}" style="--project-color: ${color};">
          <div class="project-header">
            <div>
              <h3 class="project-title">${name}</h3>
              <p class="project-progress">0% complete</p>
            </div>
            <div class="task-actions">
              <button class="task-action-btn">
                <span class="material-icons">edit</span>
              </button>
              <button class="task-action-btn">
                <span class="material-icons">more_vert</span>
              </button>
            </div>
          </div>
          
          <div class="progress-bar">
            <div class="progress-fill" style="width: 0%;"></div>
          </div>
          
          <div class="task-list">
            <!-- Tasks will be added here -->
            <div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>
          </div>
        </div>
      `;
      
      // Add the project to the container
      projectsContainer.insertAdjacentHTML('beforeend', projectHTML);
      
      // Save projects data
      try {
        saveProjectsData();
        showNotification(`Project "${name}" created successfully!`, 'success');
        
        // Re-initialize the project options menu
        setupProjectOptionsMenu();
      } catch (err) {
        console.error('Error saving project data:', err);
        showNotification('Error creating project', 'error');
      }
    }
    
    // Add button to create a new project
    function addNewProjectButton() {
      const headerActions = document.querySelector('.dashboard-actions');
      
      if (!headerActions) {
        console.error('Dashboard actions container not found');
        return;
      }
      
      // Check if button already exists
      if (!document.getElementById('new-project-btn')) {
        const newProjectButton = document.createElement('button');
        newProjectButton.className = 'btn primary';
        newProjectButton.id = 'new-project-btn';
        newProjectButton.innerHTML = '<span class="material-icons">add</span> New Project';
        
        newProjectButton.addEventListener('click', function() {
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            modal.classList.add('active');
          } else {
            console.error('New project modal not found');
          }
        });
        
        headerActions.appendChild(newProjectButton);
      }
    }
    
    // Function to initialize everything
    function initializeProjectFeatures() {
      assignProjectIds();
      enhanceNewProjectModal();
      addNewProjectButton();
    }
    
    // Execute when DOM is loaded
    document.addEventListener('DOMContentLoaded', initializeProjectFeatures);
    
    // Also run when window is loaded
    window.addEventListener('load', initializeProjectFeatures);
    
    // Run now if DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeProjectFeatures();
    }
  </script>

  <!-- Script to save and load project data -->
  <script>
    // Function to save project data to localStorage
    function saveProjectsData() {
      console.log('Saving projects data to localStorage');
      
      const projectsData = [];
      
      // Get all project cards
      document.querySelectorAll('.project-card').forEach(projectCard => {
        const projectId = projectCard.getAttribute('data-project-id');
        const projectTitle = projectCard.querySelector('.project-title').textContent;
        const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color').trim();
        const progressElement = projectCard.querySelector('.progress-fill');
        const progressText = projectCard.querySelector('.project-progress').textContent;
        const progressValue = progressElement ? 
          parseFloat(progressElement.style.width) || 0 : 
          parseFloat(progressText) || 0;
        
        // Get tasks for this project
        const tasks = [];
        projectCard.querySelectorAll('.task-item').forEach(taskItem => {
          // Skip the empty tasks message if it exists
          if (taskItem.classList.contains('empty-tasks-message')) return;
          
          const taskId = taskItem.getAttribute('data-task-id') || `task-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
          const taskName = taskItem.querySelector('.task-name').textContent;
          const completed = taskItem.querySelector('.task-checkbox').checked;
          
          // Get task details
          let priority = 'medium';
          let estTime = '';
          let deadline = '';
          let notes = '';
          
          // Extract priority from the icon if it exists
          const priorityIcon = taskItem.querySelector('.priority-high, .priority-medium, .priority-low');
          if (priorityIcon) {
            if (priorityIcon.classList.contains('priority-high')) priority = 'high';
            else if (priorityIcon.classList.contains('priority-low')) priority = 'low';
            else priority = 'medium';
          }
          
          // Extract time, deadline, and notes if they exist
          const taskDetails = taskItem.querySelectorAll('.task-detail');
          taskDetails.forEach(detail => {
            const iconText = detail.querySelector('.material-icons')?.textContent;
            
            if (iconText === 'schedule') {
              estTime = detail.textContent.trim().replace('schedule', '').trim();
            } else if (iconText === 'event') {
              deadline = detail.textContent.trim().replace('event', '').trim();
            } else if (iconText === 'note') {
              notes = detail.textContent.trim().replace('note', '').trim();
            }
          });
          
          // Save task data
          tasks.push({
            id: taskId,
            name: taskName,
            completed: completed,
            priority: priority,
            estimatedTime: estTime,
            deadline: deadline,
            notes: notes
          });
          
          // Ensure the task has an ID attribute
          if (!taskItem.hasAttribute('data-task-id')) {
            taskItem.setAttribute('data-task-id', taskId);
          }
        });
        
        // Create project data object
        projectsData.push({
          id: projectId,
          name: projectTitle,
          color: projectColor,
          progress: progressValue,
          tasks: tasks
        });
      });
      
      // Save to localStorage
      localStorage.setItem('projectsData', JSON.stringify(projectsData));
      console.log('Saved projects data:', projectsData);
      
      // Also update the project select in the new task modal
      updateProjectSelect();
      
      return projectsData;
    }
    
    // Function to load project data from localStorage
    function loadProjectsData() {
      console.log('Loading projects data from localStorage');
      
      const projectsDataString = localStorage.getItem('projectsData');
      
      if (!projectsDataString) {
        console.log('No projects data found in localStorage');
        return;
      }
      
      try {
        const projectsData = JSON.parse(projectsDataString);
        console.log('Loaded projects data:', projectsData);
        
        // Clear the container
        const projectsContainer = document.querySelector('.projects-container');
        if (!projectsContainer) {
          console.error('Projects container not found');
          return;
        }
        
        // Remove all existing projects
        projectsContainer.innerHTML = '';
        
        // Create project cards from the data
        projectsData.forEach(project => {
          // Create project HTML
          const progressWidth = typeof project.progress === 'number' ? project.progress : parseFloat(project.progress) || 0;
          
          const projectHTML = `
            <div class="project-card" data-project-id="${project.id}" style="--project-color: ${project.color};">
              <div class="project-header">
                <div>
                  <h3 class="project-title">${project.name}</h3>
                  <p class="project-progress">${progressWidth}% complete</p>
                </div>
                <div class="task-actions">
                  <button class="task-action-btn">
                    <span class="material-icons">edit</span>
                  </button>
                  <button class="task-action-btn">
                    <span class="material-icons">more_vert</span>
                  </button>
                </div>
              </div>
              
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${progressWidth}%;"></div>
              </div>
              
              <div class="task-list">
                ${project.tasks && project.tasks.length > 0 ? '' : 
                  '<div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>'}
              </div>
            </div>
          `;
          
          // Add the project to the container
          projectsContainer.insertAdjacentHTML('beforeend', projectHTML);
          
          // Get the project card just added
          const projectCard = projectsContainer.lastElementChild;
          
          // If there are tasks, add them
          if (project.tasks && project.tasks.length > 0) {
            const taskList = projectCard.querySelector('.task-list');
            
            project.tasks.forEach(task => {
              // Create priority class
              let priorityClass = 'priority-medium';
              if (task.priority === 'high') priorityClass = 'priority-high';
              else if (task.priority === 'low') priorityClass = 'priority-low';
              
              // Create deadline class
              let deadlineClass = '';
              if (task.deadline && task.deadline.toLowerCase().includes('tomorrow')) {
                deadlineClass = 'deadline-approaching';
              }
              
              // Create task HTML
              const taskHTML = `
                <div class="task-item ${task.completed ? 'completed' : ''}" data-task-id="${task.id}">
                  <input type="checkbox" class="task-checkbox" ${task.completed ? 'checked' : ''}>
                  <div class="task-content">
                    <h4 class="task-name">${task.name}</h4>
                    <div class="task-details">
                      ${task.priority ? `
                        <span class="task-detail">
                          <span class="material-icons ${priorityClass}">flag</span>
                          ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                        </span>
                      ` : ''}
                      
                      ${task.estimatedTime ? `
                        <span class="task-detail">
                          <span class="material-icons">schedule</span>
                          ${task.estimatedTime}
                        </span>
                      ` : ''}
                      
                      ${task.deadline ? `
                        <span class="task-detail ${deadlineClass}">
                          <span class="material-icons">event</span>
                          ${task.deadline}
                        </span>
                      ` : ''}
                      
                      ${task.notes ? `
                        <span class="task-detail">
                          <span class="material-icons">note</span>
                          ${task.notes}
                        </span>
                      ` : ''}
                    </div>
                  </div>
                  <div class="task-actions">
                    <button class="task-action-btn edit-task-btn">
                      <span class="material-icons">edit</span>
                    </button>
                    <button class="task-action-btn delete-task-btn">
                      <span class="material-icons">delete</span>
                    </button>
                  </div>
                </div>
              `;
              
              // Add the task to the project
              taskList.insertAdjacentHTML('beforeend', taskHTML);
            });
          }
        });
        
        // Re-initialize all functionality
        setupProjectOptionsMenu();
        setupTaskCheckboxListeners();
        setupDeleteButtons();
        updateProjectSelect();
        
        return projectsData;
      } catch (error) {
        console.error('Error loading projects data:', error);
        return null;
      }
    }
    
    // Function to set up task checkbox listeners
    function setupTaskCheckboxListeners() {
      document.querySelectorAll('.task-checkbox').forEach(checkbox => {
        // Remove existing listeners
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
        
        // Add new listener
        newCheckbox.addEventListener('change', function() {
          const taskItem = this.closest('.task-item');
          
          if (this.checked) {
            taskItem.classList.add('completed');
          } else {
            taskItem.classList.remove('completed');
          }
          
          // Update project progress
          updateProjectProgress(this.closest('.project-card'));
          
          // Save data
          saveProjectsData();
        });
      });
    }
    
    // Function to update project progress
    function updateProjectProgress(projectCard) {
      if (!projectCard) return;
      
      const taskItems = projectCard.querySelectorAll('.task-item');
      const totalTasks = taskItems.length;
      
      if (totalTasks === 0) {
        // No tasks, set progress to 0
        projectCard.querySelector('.progress-fill').style.width = '0%';
        projectCard.querySelector('.project-progress').textContent = '0% complete';
        return;
      }
      
      const completedTasks = projectCard.querySelectorAll('.task-item.completed').length;
      const progressPercentage = Math.round((completedTasks / totalTasks) * 100);
      
      // Update progress bar and text
      projectCard.querySelector('.progress-fill').style.width = `${progressPercentage}%`;
      projectCard.querySelector('.project-progress').textContent = `${progressPercentage}% complete`;
    }
    
    // Function to update project select in new task modal
    function updateProjectSelect() {
      const projectSelect = document.getElementById('new-task-project');
      
      if (!projectSelect) {
        console.log('Project select element not found');
        return;
      }
      
      // Clear existing options
      projectSelect.innerHTML = '';
      
      // Add default option
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select a project';
      projectSelect.appendChild(defaultOption);
      
      // Add options for each project
      document.querySelectorAll('.project-card').forEach(projectCard => {
        const projectId = projectCard.getAttribute('data-project-id');
        const projectTitle = projectCard.querySelector('.project-title').textContent;
        
        const option = document.createElement('option');
        option.value = projectId;
        option.textContent = projectTitle;
        
        projectSelect.appendChild(option);
      });
    }
    
    // Setup delete buttons for tasks
    function setupDeleteButtons() {
      // For task deletion
      document.querySelectorAll('.delete-task-btn').forEach(btn => {
        // Remove existing listeners
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        // Add new listener
        newBtn.addEventListener('click', function() {
          const taskItem = this.closest('.task-item');
          const taskName = taskItem.querySelector('.task-name').textContent;
          
          if (confirm(`Are you sure you want to delete task "${taskName}"?`)) {
            // Remove the task
            taskItem.remove();
            
            // Update project progress
            updateProjectProgress(this.closest('.project-card'));
            
            // Save data
            saveProjectsData();
            
            showNotification(`Task "${taskName}" deleted successfully!`, 'success');
          }
        });
      });
    }
    
    // Load projects when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadProjectsData();
    });
    
    // Also run when window is loaded
    window.addEventListener('load', function() {
      loadProjectsData();
    });
    
    // Run now if DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      loadProjectsData();
    }
    
    // Update the save function for the new task form
    document.addEventListener('DOMContentLoaded', function() {
      const saveNewTaskOriginal = window.saveNewTask;
      
      if (typeof saveNewTaskOriginal === 'function') {
        window.saveNewTask = function() {
          const result = saveNewTaskOriginal.apply(this, arguments);
          
          // After saving the task, save all projects data
          if (result !== false) {
            saveProjectsData();
          }
          
          return result;
        };
      }
    });
  </script>

  <!-- Fix script to ensure interactive elements work properly -->
  <script>
    // This script ensures all interactive elements work properly even when localStorage is empty
    
    // Function to initialize default projects if none exist
    function initializeDefaultProjectsIfNeeded() {
      console.log('Checking if default projects need to be created');
      
      // Get existing projects
      const projectCards = document.querySelectorAll('.project-card');
      
      // If no projects exist, create default ones
      if (projectCards.length === 0) {
        console.log('No projects found, creating defaults');
        
        // Sample project data
        const defaultProjects = [
          {
            name: 'Website Redesign',
            color: '#4f46e5', // Blue
            progress: 70
          },
          {
            name: 'Mobile App',
            color: '#10b981', // Green
            progress: 45
          },
          {
            name: 'Marketing Campaign',
            color: '#f59e0b', // Orange
            progress: 20
          }
        ];
        
        // Create default projects
        defaultProjects.forEach(project => {
          createNewProject(project.name, project.color, project.progress);
        });
        
        // Save to localStorage
        saveProjectsData();
      }
    }
    
    // Function to ensure all elements are enabled and clickable
    function enableAllInteractiveElements() {
      console.log('Enabling all interactive elements');
      
      // Remove any overlays that might be blocking interaction
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        if (!overlay.classList.contains('active')) {
          overlay.style.display = 'none';
        }
      });
      
      // Ensure all buttons are clickable
      document.querySelectorAll('button').forEach(button => {
        button.style.pointerEvents = 'auto';
        
        // Clone and replace to remove any stale event listeners
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);
      });
      
      // Ensure all checkboxes are clickable
      document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.style.pointerEvents = 'auto';
        
        // Clone and replace to remove any stale event listeners
        const newCheckbox = checkbox.cloneNode(true);
        checkbox.parentNode.replaceChild(newCheckbox, checkbox);
      });
      
      // Set up event listeners for the New Project and New Task buttons
      setupMainButtons();
      
      // Re-initialize all event handlers
      setupTaskCheckboxListeners();
      setupDeleteButtons();
      setupProjectOptionsMenu();
      initializeProjectFeatures();
    }
    
    // Set up the main New Project and New Task buttons
    function setupMainButtons() {
      console.log('Setting up main buttons');
      
      // New Task button - using standard selectors only
      const newTaskBtn = document.querySelector('.btn.primary[aria-label="New Task"], button.btn[data-modal="new-task-modal"]');
      if (!newTaskBtn) {
        // Try alternate methods to find the New Task button
        const allButtons = document.querySelectorAll('button.btn.primary');
        let foundButton = null;
        
        // Find button by text content
        allButtons.forEach(btn => {
          if (btn.textContent && btn.textContent.trim().includes('New Task')) {
            foundButton = btn;
          }
        });
        
        if (foundButton) {
          console.log('Found New Task button by text content');
          
          // Clone and replace to remove stale event listeners
          const newBtn = foundButton.cloneNode(true);
          foundButton.parentNode.replaceChild(newBtn, foundButton);
          
          // Add event listener
          newBtn.addEventListener('click', function() {
            console.log('New Task button clicked');
            const modal = document.getElementById('new-task-modal');
            if (modal) {
              modal.classList.add('active');
              updateProjectSelect(); // Update project dropdown
            } else {
              console.error('New task modal not found');
            }
          });
        } else {
          console.error('New Task button not found using multiple methods');
        }
      } else {
        console.log('Found New Task button');
        
        // Clone and replace to remove stale event listeners
        const newBtn = newTaskBtn.cloneNode(true);
        newTaskBtn.parentNode.replaceChild(newBtn, newTaskBtn);
        
        // Add event listener
        newBtn.addEventListener('click', function() {
          console.log('New Task button clicked');
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            modal.classList.add('active');
            updateProjectSelect(); // Update project dropdown
          } else {
            console.error('New task modal not found');
          }
        });
      }
      
      // If New Project button doesn't exist in the actions area, create it
      const headerActions = document.querySelector('.dashboard-actions');
      const existingNewProjectBtn = document.getElementById('new-project-btn');
      
      if (headerActions && !existingNewProjectBtn) {
        console.log('Adding New Project button');
        
        const newProjectButton = document.createElement('button');
        newProjectButton.className = 'btn primary';
        newProjectButton.id = 'new-project-btn';
        newProjectButton.innerHTML = '<span class="material-icons">add</span> New Project';
        
        newProjectButton.addEventListener('click', function() {
          console.log('New Project button clicked');
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            modal.classList.add('active');
          } else {
            console.error('New project modal not found');
            // Create modal if it doesn't exist
            enhanceNewProjectModal();
            
            // Try again
            const newModal = document.getElementById('new-project-modal');
            if (newModal) {
              newModal.classList.add('active');
            }
          }
        });
        
        headerActions.appendChild(newProjectButton);
      }
    }
    
    // Run the fix functions
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM content loaded, running fixes');
      
      // Wait a short time to ensure everything is loaded
      setTimeout(function() {
        // Try to load projects data
        try {
          loadProjectsData();
        } catch (error) {
          console.error('Error loading projects data:', error);
        }
        
        // Create defaults if needed
        initializeDefaultProjectsIfNeeded();
        
        // Enable all interactive elements
        enableAllInteractiveElements();
      }, 500);
    });
    
    // Also run when window is fully loaded
    window.addEventListener('load', function() {
      console.log('Window loaded, running fixes');
      
      // Try to load projects data
      try {
        loadProjectsData();
      } catch (error) {
        console.error('Error loading projects data:', error);
      }
      
      // Create defaults if needed
      initializeDefaultProjectsIfNeeded();
      
      // Enable all interactive elements
      enableAllInteractiveElements();
      
      // Special handling for existing inactive projects
      if (document.querySelectorAll('.project-card').length > 0) {
        console.log('Projects exist but might be inactive, forcing enablement');
        document.querySelectorAll('.task-actions button').forEach(button => {
          button.style.pointerEvents = 'auto';
          button.style.cursor = 'pointer';
        });
        
        document.querySelectorAll('.project-card').forEach(card => {
          card.style.pointerEvents = 'auto';
        });
      }
    });
    
    // Run immediately if the page is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
      console.log('Document already ready, running fixes immediately');
      
      // Try to load projects data
      try {
        loadProjectsData();
      } catch (error) {
        console.error('Error loading projects data:', error);
      }
      
      // Create defaults if needed
      initializeDefaultProjectsIfNeeded();
      
      // Enable all interactive elements
      enableAllInteractiveElements();
    }
  </script>

  <!-- Add the New Project button functionality back
  // If New Project button doesn't exist in the actions area, create it -->
  <script>
    // Add the New Project button functionality back
    // If New Project button doesn't exist in the actions area, create it
    const headerActions = document.querySelector('.dashboard-actions');
    const existingNewProjectBtn = document.getElementById('new-project-btn');

    if (headerActions && !existingNewProjectBtn) {
      console.log('Adding New Project button');
      
      const newProjectButton = document.createElement('button');
      newProjectButton.className = 'btn primary';
      newProjectButton.id = 'new-project-btn';
      newProjectButton.innerHTML = '<span class="material-icons">add</span> New Project';
      
      newProjectButton.addEventListener('click', function() {
        console.log('New Project button clicked');
        const modal = document.getElementById('new-project-modal');
        if (modal) {
          modal.classList.add('active');
        } else {
          console.error('New project modal not found');
          // Create modal if it doesn't exist
          enhanceNewProjectModal();
          
          // Try again
          const newModal = document.getElementById('new-project-modal');
          if (newModal) {
            newModal.classList.add('active');
          }
        }
      });
      
      headerActions.appendChild(newProjectButton);
    }
  </script>

  <!-- Simple direct fix script for modern UI -->
  <script>
    // Direct approach to fix buttons and functionality without complex selectors
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded - applying direct fixes for production UI');
      
      // Wait for the UI to stabilize
      setTimeout(function() {
        // Find buttons using attributes and text content directly
        const directButtonFix = function() {
          // Look for the actual buttons in the header based on the screenshot
          const allButtons = document.querySelectorAll('button');
          console.log('Found', allButtons.length, 'buttons in document');
          
          allButtons.forEach(button => {
            // Log the button text to debug
            console.log('Button text:', button.textContent.trim());
            
            // Check if it's the New Project button
            if (button.textContent.includes('New Project')) {
              console.log('Found New Project button');
              
              // Add direct click handler
              button.addEventListener('click', function(e) {
                console.log('New Project button clicked');
                
                // Instead of using prompt, create a project with a default name
                const timestamp = new Date().toLocaleTimeString();
                const projectName = `New Project (${timestamp})`;
                const projectColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                
                // Create project in UI
                const projectsContainer = document.querySelector('.projects-container') || 
                                         document.querySelector('[role="main"]');
                
                if (projectsContainer) {
                  // Create project element based on the visible UI structure
                  const newProject = document.createElement('div');
                  newProject.className = 'project-card';
                  newProject.setAttribute('data-project-id', 'project-' + Date.now());
                  newProject.style.setProperty('--project-color', projectColor);
                  
                  // Set HTML based on the actual UI structure
                  newProject.innerHTML = `
                    <div class="project-header">
                      <div>
                        <h3 class="project-title">${projectName}</h3>
                        <p class="project-progress">0% complete</p>
                      </div>
                      <div class="task-actions">
                        <button class="task-action-btn">
                          <span class="material-icons">edit</span>
                        </button>
                        <button class="task-action-btn">
                          <span class="material-icons">delete</span>
                        </button>
                      </div>
                    </div>
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div class="task-list">
                      <div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>
                    </div>
                  `;
                  
                  projectsContainer.appendChild(newProject);
                  
                  // Save to localStorage
                  try {
                    saveProjectsData();
                  } catch (err) {
                    console.error('Error saving new project:', err);
                  }
                  
                  alert(`Project "${projectName}" created successfully! You can edit it by clicking the edit icon.`);
                  
                  // Set up delete functionality for the new project
                  setupDeleteFunctionality();
                }
              });
            }
            
            // Check if it's the New Task button
            if (button.textContent.includes('New Task')) {
              console.log('Found New Task button');
              
              // Add direct click handler
              button.addEventListener('click', function(e) {
                console.log('New Task button clicked');
                
                // Instead of using prompt, create a task with a default name
                const timestamp = new Date().toLocaleTimeString();
                const taskName = `New Task (${timestamp})`;
                
                // Find all projects
                const projects = document.querySelectorAll('.project-card');
                if (projects.length === 0) {
                  alert('Please create a project first');
                  return;
                }
                
                // Use the first project as default
                const firstProject = projects[0];
                const projectTitle = firstProject.querySelector('.project-title').textContent;
                
                const taskList = firstProject.querySelector('.task-list');
                if (taskList) {
                  // Remove empty message if present
                  const emptyMessage = taskList.querySelector('.empty-tasks-message');
                  if (emptyMessage) {
                    emptyMessage.remove();
                  }
                  
                  // Create a new task with default attributes
                  const taskItem = document.createElement('div');
                  taskItem.className = 'task-item';
                  taskItem.setAttribute('data-task-id', 'task-' + Date.now());
                  
                  taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox">
                    <div class="task-content">
                      <h4 class="task-name">${taskName}</h4>
                      <div class="task-details">
                        <span class="task-detail">
                          <span class="material-icons priority-medium">flag</span>
                          Medium
                        </span>
                        <span class="task-detail">
                          <span class="material-icons">schedule</span>
                          30m
                        </span>
                      </div>
                    </div>
                    <div class="task-actions">
                      <button class="task-action-btn edit-task-btn">
                        <span class="material-icons">edit</span>
                      </button>
                      <button class="task-action-btn delete-task-btn">
                        <span class="material-icons">delete</span>
                      </button>
                    </div>
                  `;
                  
                  taskList.appendChild(taskItem);
                  
                  // Update project progress
                  updateProjectProgress(firstProject);
                  
                  // Save to localStorage
                  try {
                    saveProjectsData();
                  } catch (err) {
                    console.error('Error saving new task:', err);
                  }
                  
                  alert(`Task "${taskName}" created in project "${projectTitle}" successfully! You can edit it by clicking the edit icon.`);
                  
                  // Set up delete functionality for the new task
                  setupDeleteFunctionality();
                }
              });
            }
          });
        };
        
        // Apply the direct button fix
        directButtonFix();
        
        // Make all buttons clickable
        document.querySelectorAll('button').forEach(button => {
          button.style.pointerEvents = 'auto';
          button.style.cursor = 'pointer';
        });
        
        // Make all checkboxes clickable
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.style.pointerEvents = 'auto';
          checkbox.style.cursor = 'pointer';
          
          // Add direct event listener
          checkbox.addEventListener('change', function() {
            console.log('Checkbox toggled:', this.checked);
            
            // Update task styling
            const taskItem = this.closest('.task-item');
            if (taskItem) {
              if (this.checked) {
                taskItem.classList.add('completed');
              } else {
                taskItem.classList.remove('completed');
              }
              
              // Update project progress
              const projectCard = taskItem.closest('.project-card');
              if (projectCard) {
                const allTasks = projectCard.querySelectorAll('.task-item');
                const completedTasks = projectCard.querySelectorAll('.task-item.completed, .task-item input:checked');
                
                const progress = Math.round((completedTasks.length / allTasks.length) * 100) || 0;
                
                const progressBar = projectCard.querySelector('.progress-fill');
                const progressText = projectCard.querySelector('.project-progress');
                
                if (progressBar) progressBar.style.width = `${progress}%`;
                if (progressText) progressText.textContent = `${progress}% complete`;
              }
            }
          });
        });
        
        console.log('Direct fixes applied successfully');
      }, 1000); // Increase timeout to ensure UI is loaded
    });
  </script>

  <!-- Edit Project Modal -->
  <div id="edit-project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Project</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="edit-project-form">
          <input type="hidden" id="edit-project-id">
          <div class="form-group">
            <label for="edit-project-name">Project Name</label>
            <input type="text" id="edit-project-name" required>
          </div>
          <div class="form-group">
            <label for="edit-project-color">Project Color</label>
            <div class="color-selector">
              <input type="color" id="edit-project-color">
              <div class="color-presets">
                <div class="color-preset" data-color="#4f46e5" style="background-color: #4f46e5;"></div>
                <div class="color-preset" data-color="#10b981" style="background-color: #10b981;"></div>
                <div class="color-preset" data-color="#f59e0b" style="background-color: #f59e0b;"></div>
                <div class="color-preset" data-color="#ef4444" style="background-color: #ef4444;"></div>
                <div class="color-preset" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
              </div>
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn secondary-btn close-modal">Cancel</button>
            <button type="button" id="update-project-btn" class="btn primary-btn">Update Project</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add this script to handle color preset selection and modal interactions -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Setup color picker presets
      const colorInput = document.getElementById('edit-project-color');
      const presets = document.querySelectorAll('.color-preset');
      const editProjectModal = document.getElementById('edit-project-modal');
      const closeEditModalBtn = document.getElementById('close-edit-project-modal');
      const cancelEditProjectBtn = document.getElementById('cancel-edit-project');
      const saveProjectBtn = document.getElementById('save-project');
      const editProjectIdInput = document.getElementById('edit-project-id');
      
      // Handle modal close events
      function closeEditModal() {
        editProjectModal.style.display = 'none';
        editProjectModal.style.opacity = '0';
        editProjectModal.style.visibility = 'hidden';
      }
      
      if (closeEditModalBtn) {
        closeEditModalBtn.addEventListener('click', closeEditModal);
      }
      
      if (cancelEditProjectBtn) {
        cancelEditProjectBtn.addEventListener('click', closeEditModal);
      }
      
      // Setup edit buttons on project cards
      function setupEditButtons() {
        document.querySelectorAll('.project-header .task-action-btn').forEach(btn => {
          const icon = btn.querySelector('.material-icons');
          if (icon && (icon.textContent === 'edit' || icon.textContent === 'more_vert')) {
            // Remove any existing event listeners
            const newBtn = btn.cloneNode(true);
            if (btn.parentNode) {
              btn.parentNode.replaceChild(newBtn, btn);
            }
            
            newBtn.addEventListener('click', function(e) {
              e.stopPropagation();
              const projectCard = this.closest('.project-card');
              if (projectCard) {
                const projectId = projectCard.getAttribute('data-project-id') || '';
                const projectTitle = projectCard.querySelector('.project-title')?.textContent || '';
                const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color').trim() || '#4f46e5';
                
                // Fill the form
                const nameInput = document.getElementById('edit-project-name');
                const colorInput = document.getElementById('edit-project-color');
                
                if (nameInput) nameInput.value = projectTitle;
                if (colorInput) {
                  colorInput.value = projectColor;
                  updateActivePreset(projectColor);
                }
                if (editProjectIdInput) {
                  editProjectIdInput.value = projectId;
                }
                
                // Show the modal with animation
                editProjectModal.style.display = 'flex';
                setTimeout(() => {
                  editProjectModal.style.opacity = '1';
                  editProjectModal.style.visibility = 'visible';
                }, 10);
              }
            });
          }
        });
      }
      
      // Setup once on page load
      setupEditButtons();
      
      // Also run after any project updates
      document.addEventListener('projectsUpdated', setupEditButtons);
      
      // Setup project saving
      if (saveProjectBtn) {
        saveProjectBtn.addEventListener('click', function() {
          const nameInput = document.getElementById('edit-project-name');
          const colorInput = document.getElementById('edit-project-color');
          const projectId = editProjectIdInput.value;
          
          // Validate inputs
          if (!nameInput || !nameInput.value.trim()) {
            alert('Please enter a project name');
            return;
          }
          
          // Find the project card
          const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
          if (projectCard) {
            // Update project name
            const titleEl = projectCard.querySelector('.project-title');
            if (titleEl) {
              titleEl.textContent = nameInput.value.trim();
            }
            
            // Update project color
            projectCard.style.setProperty('--project-color', colorInput.value);
            
            // Save to localStorage
            try {
              saveProjectsData();
              alert(`Project "${nameInput.value.trim()}" updated successfully!`);
            } catch (err) {
              console.error('Error saving project data:', err);
              alert('Error updating project. Please try again.');
            }
          }
          
          // Close the modal
          closeEditModal();
        });
      }
      
      if (colorInput && presets.length) {
        // Mark the default color as active
        updateActivePreset(colorInput.value);
        
        // Add click handlers to presets
        presets.forEach(preset => {
          preset.addEventListener('click', function() {
            const color = this.getAttribute('data-color');
            colorInput.value = color;
            updateActivePreset(color);
          });
        });
        
        // Update active preset when color input changes
        colorInput.addEventListener('input', function() {
          updateActivePreset(this.value);
        });
      }
      
      function updateActivePreset(color) {
        presets.forEach(preset => {
          const presetColor = preset.getAttribute('data-color');
          if (presetColor === color) {
            preset.classList.add('active');
          } else {
            preset.classList.remove('active');
          }
        });
      }
    });
  </script>

  <!-- Add proper modal dialogs for creating new projects and tasks -->
  <div id="new-project-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create New Project</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="new-project-name" class="form-label">Project Name</label>
          <input type="text" id="new-project-name" class="form-input" placeholder="Enter project name">
        </div>
        <div class="form-group">
          <label for="new-project-color" class="form-label">Project Color</label>
          <div class="color-selector">
            <input type="color" id="new-project-color" class="form-input color-input" value="#4f46e5">
            <div class="color-presets">
              <div class="color-preset active" data-color="#4f46e5" style="background-color: #4f46e5;"></div>
              <div class="color-preset" data-color="#10b981" style="background-color: #10b981;"></div>
              <div class="color-preset" data-color="#f59e0b" style="background-color: #f59e0b;"></div>
              <div class="color-preset" data-color="#ef4444" style="background-color: #ef4444;"></div>
              <div class="color-preset" data-color="#8b5cf6" style="background-color: #8b5cf6;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn secondary-btn" id="cancel-new-project">Cancel</button>
        <button class="btn primary-btn" id="create-project">Create Project</button>
      </div>
    </div>
  </div>

  <div id="new-task-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Create New Task</h3>
        <span class="close-modal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="new-task-name" class="form-label">Task Name</label>
          <input type="text" id="new-task-name" class="form-input" placeholder="Enter task name">
        </div>
        <div class="form-group">
          <label for="new-task-project" class="form-label">Project</label>
          <select id="new-task-project" class="form-input">
            <!-- Will be populated dynamically -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Priority</label>
          <div class="priority-options">
            <label class="priority-option">
              <input type="radio" name="new-task-priority" value="low" checked>
              <span class="priority-label priority-low">
                <span class="material-icons">assistant_flag</span>Low
              </span>
            </label>
            <label class="priority-option">
              <input type="radio" name="new-task-priority" value="medium">
              <span class="priority-label priority-medium">
                <span class="material-icons">outlined_flag</span>Medium
              </span>
            </label>
            <label class="priority-option">
              <input type="radio" name="new-task-priority" value="high">
              <span class="priority-label priority-high">
                <span class="material-icons">flag</span>High
              </span>
            </label>
          </div>
        </div>
        <div class="form-group">
          <label for="new-task-time" class="form-label">Estimated Time</label>
          <input type="text" id="new-task-time" class="form-input" placeholder="e.g. 2h 30m">
        </div>
        <div class="form-group">
          <label for="new-task-deadline" class="form-label">Deadline (Optional)</label>
          <input type="date" id="new-task-deadline" class="form-input">
        </div>
        <div class="form-actions">
          <button type="button" class="btn secondary-btn close-modal">Cancel</button>
          <button type="button" id="create-task-btn" class="btn primary-btn">Create Task</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add script for edit and delete functionality -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Setup edit and delete functionality
      setupEditAndDeleteFunctionality();
      
      // Re-apply functionality whenever the DOM might change
      setInterval(setupEditAndDeleteFunctionality, 2000);
    });
    
    function setupEditAndDeleteFunctionality() {
      console.log("Setting up edit and delete functionality");
      
      // Get modal elements for editing
      const editProjectModal = document.getElementById('edit-project-modal');
      const editTaskModal = document.getElementById('edit-task-modal');
      
      // Setup edit project buttons
      document.querySelectorAll('.project-header .task-actions button:has(.material-icons:contains("edit"))').forEach(button => {
        button.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find the project
          const projectCard = button.closest('.project-card');
          if (!projectCard) return;
          
          const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
          const projectTitle = projectCard.querySelector('.project-title').textContent;
          const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color') || '#4f46e5';
          
          // Populate the edit form
          document.getElementById('edit-project-id').value = projectId;
          document.getElementById('edit-project-name').value = projectTitle;
          document.getElementById('edit-project-color').value = projectColor;
          
          // Show the modal
          editProjectModal.style.display = 'flex';
          setTimeout(() => {
            editProjectModal.style.opacity = '1';
            editProjectModal.style.visibility = 'visible';
            document.getElementById('edit-project-name').focus();
          }, 10);
        };
      });
      
      // Setup edit task buttons
      document.querySelectorAll('.task-item .task-actions button:has(.material-icons:contains("edit"))').forEach(button => {
        button.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find the task
          const taskItem = button.closest('.task-item');
          if (!taskItem) return;
          
          const taskId = taskItem.getAttribute('data-task-id') || taskItem.id;
          const taskName = taskItem.querySelector('.task-name').textContent;
          
          // Get the priority
          let priority = 'medium';
          if (taskItem.querySelector('.priority-high')) {
            priority = 'high';
          } else if (taskItem.querySelector('.priority-low')) {
            priority = 'low';
          }
          
          // Get time and deadline if available
          let estimatedTime = '';
          let deadline = '';
          
          taskItem.querySelectorAll('.task-detail').forEach(detail => {
            const icon = detail.querySelector('.material-icons');
            if (icon && icon.textContent === 'schedule') {
              estimatedTime = detail.textContent.trim().replace('schedule', '').trim();
            } else if (icon && icon.textContent === 'event') {
              deadline = detail.textContent.trim().replace('event', '').trim();
            }
          });
          
          // Find current project
          const projectCard = taskItem.closest('.project-card');
          const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
          
          // Populate edit form
          document.getElementById('edit-task-id').value = taskId;
          document.getElementById('edit-task-name').value = taskName;
          
          // Set priority radio button
          document.querySelector(`input[name="edit-task-priority"][value="${priority}"]`).checked = true;
          
          // Set estimated time and deadline
          document.getElementById('edit-task-time').value = estimatedTime;
          document.getElementById('edit-task-deadline').value = deadline;
          
          // Populate project dropdown
          const editTaskProjectSelect = document.getElementById('edit-task-project');
          editTaskProjectSelect.innerHTML = '';
          
          document.querySelectorAll('.project-card').forEach(project => {
            const title = project.querySelector('.project-title').textContent;
            const id = project.getAttribute('data-project-id') || project.id;
            
            const option = document.createElement('option');
            option.value = id;
            option.textContent = title;
            option.selected = (id === projectId);
            
            editTaskProjectSelect.appendChild(option);
          });
          
          // Show the modal
          editTaskModal.style.display = 'flex';
          setTimeout(() => {
            editTaskModal.style.opacity = '1';
            editTaskModal.style.visibility = 'visible';
            document.getElementById('edit-task-name').focus();
          }, 10);
        };
      });
      
      // Setup delete project buttons
      document.querySelectorAll('.project-header .task-actions button:has(.material-icons:contains("delete"))').forEach(button => {
        button.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find the project
          const projectCard = button.closest('.project-card');
          if (!projectCard) return;
          
          const projectTitle = projectCard.querySelector('.project-title').textContent;
          
          // Confirm deletion
          if (confirm(`Are you sure you want to delete the project "${projectTitle}" and all its tasks?`)) {
            // Remove from DOM
            projectCard.remove();
            
            // Save changes
            try {
              saveProjectsData();
            } catch (err) {
              console.error('Error saving after project deletion:', err);
            }
            
            // Show confirmation
            alert(`Project "${projectTitle}" has been deleted successfully.`);
          }
        };
      });
      
      // Setup delete task buttons
      document.querySelectorAll('.task-item .task-actions button:has(.material-icons:contains("delete"))').forEach(button => {
        button.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          // Find the task
          const taskItem = button.closest('.task-item');
          if (!taskItem) return;
          
          const taskName = taskItem.querySelector('.task-name').textContent;
          
          // Confirm deletion
          if (confirm(`Are you sure you want to delete the task "${taskName}"?`)) {
            // Get the project card to update progress
            const projectCard = taskItem.closest('.project-card');
            
            // Remove from DOM
            taskItem.remove();
            
            // Update project progress if needed
            if (projectCard) {
              updateProjectProgress(projectCard);
              
              // Check if task list is empty
              const taskList = projectCard.querySelector('.task-list');
              if (taskList && !taskList.querySelector('.task-item')) {
                taskList.innerHTML = '<div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>';
              }
            }
            
            // Save changes
            try {
              saveProjectsData();
            } catch (err) {
              console.error('Error saving after task deletion:', err);
            }
            
            // Show confirmation
            alert(`Task "${taskName}" has been deleted successfully.`);
          }
        };
      });
      
      // Handle update project button
      document.getElementById('update-project').onclick = function() {
        const projectId = document.getElementById('edit-project-id').value;
        const projectName = document.getElementById('edit-project-name').value.trim();
        const projectColor = document.getElementById('edit-project-color').value;
        
        if (!projectName) {
          alert('Please enter a project name');
          return;
        }
        
        // Find the project
        const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`) || 
                            document.getElementById(projectId);
        
        if (projectCard) {
          // Update the project
          projectCard.querySelector('.project-title').textContent = projectName;
          projectCard.style.setProperty('--project-color', projectColor);
          
          // Save changes
          try {
            saveProjectsData();
          } catch (err) {
            console.error('Error saving project updates:', err);
          }
          
          // Close the modal
          closeEditProjectModal();
          
          // Show confirmation
          alert(`Project "${projectName}" has been updated successfully.`);
        }
      };
      
      // Handle update task button
      document.getElementById('update-task').onclick = function() {
        const taskId = document.getElementById('edit-task-id').value;
        const taskName = document.getElementById('edit-task-name').value.trim();
        const projectId = document.getElementById('edit-task-project').value;
        const priority = document.querySelector('input[name="edit-task-priority"]:checked').value;
        const estTime = document.getElementById('edit-task-time').value.trim();
        const deadline = document.getElementById('edit-task-deadline').value.trim();
        
        if (!taskName) {
          alert('Please enter a task name');
          return;
        }
        
        // Find the task
        const taskItem = document.querySelector(`.task-item[data-task-id="${taskId}"]`) || 
                          document.getElementById(taskId);
        
        // Find the current and new project
        const currentProjectCard = taskItem ? taskItem.closest('.project-card') : null;
        const newProjectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`) || 
                              document.getElementById(projectId);
        
        if (taskItem && newProjectCard) {
          // Check if we need to move the task to a different project
          if (currentProjectCard && currentProjectCard !== newProjectCard) {
            // Move to new project
            const taskList = newProjectCard.querySelector('.task-list');
            
            // Remove empty message if present
            const emptyMessage = taskList.querySelector('.empty-tasks-message');
            if (emptyMessage) {
              emptyMessage.remove();
            }
            
            // Move the task
            taskList.appendChild(taskItem);
            
            // Update old project progress
            updateProjectProgress(currentProjectCard);
            
            // Check if old project task list is now empty
            const oldTaskList = currentProjectCard.querySelector('.task-list');
            if (oldTaskList && !oldTaskList.querySelector('.task-item')) {
              oldTaskList.innerHTML = '<div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>';
            }
          }
          
          // Get priority class
          let priorityClass = 'priority-medium';
          if (priority === 'high') priorityClass = 'priority-high';
          else if (priority === 'low') priorityClass = 'priority-low';
          
          // Update task content
          taskItem.querySelector('.task-name').textContent = taskName;
          
          // Clear details and recreate
          const detailsContainer = taskItem.querySelector('.task-details');
          detailsContainer.innerHTML = `
            <span class="task-detail">
              <span class="material-icons ${priorityClass}">flag</span>
              ${priority.charAt(0).toUpperCase() + priority.slice(1)}
            </span>
            <span class="task-detail">
              <span class="material-icons">schedule</span>
              ${estTime || '30m'}
            </span>
            ${deadline ? `
            <span class="task-detail">
              <span class="material-icons">event</span>
              ${deadline}
            </span>
            ` : ''}
          `;
          
          // Update project progress
          updateProjectProgress(newProjectCard);
          
          // Save changes
          try {
            saveProjectsData();
          } catch (err) {
            console.error('Error saving task updates:', err);
          }
          
          // Close the modal
          closeEditTaskModal();
          
          // Show confirmation
          alert(`Task "${taskName}" has been updated successfully.`);
        }
      };
      
      // Setup close buttons for edit modals
      document.getElementById('close-edit-project-modal').onclick = closeEditProjectModal;
      document.getElementById('cancel-edit-project').onclick = closeEditProjectModal;
      document.getElementById('close-edit-task-modal').onclick = closeEditTaskModal;
      document.getElementById('cancel-edit-task').onclick = closeEditTaskModal;
    }
    
    function closeEditProjectModal() {
      const modal = document.getElementById('edit-project-modal');
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      setTimeout(() => { modal.style.display = 'none'; }, 300);
    }
    
    function closeEditTaskModal() {
      const modal = document.getElementById('edit-task-modal');
      modal.style.opacity = '0';
      modal.style.visibility = 'hidden';
      setTimeout(() => { modal.style.display = 'none'; }, 300);
    }
    
    function updateProjectProgress(projectCard) {
      if (!projectCard) return;
      
      const tasks = projectCard.querySelectorAll('.task-item');
      const totalTasks = tasks.length;
      
      if (totalTasks === 0) {
        projectCard.querySelector('.project-progress').textContent = '0% complete';
        projectCard.querySelector('.progress-fill').style.width = '0%';
        return;
      }
      
      let completedTasks = 0;
      tasks.forEach(task => {
        if (task.querySelector('.task-checkbox').checked) {
          completedTasks++;
        }
      });
      
      const progressPercent = Math.round((completedTasks / totalTasks) * 100);
      projectCard.querySelector('.project-progress').textContent = `${progressPercent}% complete`;
      projectCard.querySelector('.progress-fill').style.width = `${progressPercent}%`;
    }
    
    // Helper function to save projects data to localStorage
    function saveProjectsData() {
      const projectsContainer = document.querySelector('.projects-container') || document.querySelector('[role="main"]');
      if (!projectsContainer) return;
      
      const projectsData = [];
      
      projectsContainer.querySelectorAll('.project-card').forEach(projectCard => {
        const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
        const projectTitle = projectCard.querySelector('.project-title').textContent;
        const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color') || '#4f46e5';
        
        const tasks = [];
        projectCard.querySelectorAll('.task-item').forEach(taskItem => {
          const taskId = taskItem.getAttribute('data-task-id') || taskItem.id;
          const taskName = taskItem.querySelector('.task-name').textContent;
          const isCompleted = taskItem.querySelector('.task-checkbox').checked;
          
          // Get priority
          let priority = 'medium';
          if (taskItem.querySelector('.priority-high')) {
            priority = 'high';
          } else if (taskItem.querySelector('.priority-low')) {
            priority = 'low';
          }
          
          // Get time and deadline if available
          let estimatedTime = '';
          let deadline = '';
          
          taskItem.querySelectorAll('.task-detail').forEach(detail => {
            const icon = detail.querySelector('.material-icons');
            if (icon && icon.textContent === 'schedule') {
              estimatedTime = detail.textContent.trim().replace('schedule', '').trim();
            } else if (icon && icon.textContent === 'event') {
              deadline = detail.textContent.trim().replace('event', '').trim();
            }
          });
          
          tasks.push({
            id: taskId,
            name: taskName,
            isCompleted,
            priority,
            estimatedTime,
            deadline
          });
        });
        
        projectsData.push({
          id: projectId,
          title: projectTitle,
          color: projectColor,
          tasks
        });
      });
      
      localStorage.setItem('tempus_projects', JSON.stringify(projectsData));
      console.log('Projects data saved to localStorage', projectsData);
    }
  </script>

  <script>
    // Direct fix for edit buttons
    document.addEventListener('DOMContentLoaded', function() {
      // Apply direct edit button handlers immediately and periodically
      applyEditButtonHandlers();
      setInterval(applyEditButtonHandlers, 1000);
    });
    
    function applyEditButtonHandlers() {
      console.log("Applying direct edit button handlers");
      
      // For Project Edit Buttons - try multiple selector approaches
      document.querySelectorAll('button').forEach(button => {
        // Check if this is an edit button
        const icon = button.querySelector('.material-icons');
        if (icon && icon.textContent === 'edit') {
          // Check if it's in a project header
          const projectHeader = button.closest('.project-header');
          if (projectHeader) {
            // This is a project edit button
            console.log("Found project edit button", button);
            
            // Remove existing click handlers
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Add click handler
            newButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Project edit button clicked");
              
              // Find the project
              const projectCard = newButton.closest('.project-card');
              if (!projectCard) {
                console.error("Could not find project card");
                return;
              }
              
              const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
              const projectTitle = projectCard.querySelector('.project-title').textContent;
              const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color') || '#4f46e5';
              
              console.log("Editing project:", { projectId, projectTitle, projectColor });
              
              // Populate the edit form
              document.getElementById('edit-project-id').value = projectId;
              document.getElementById('edit-project-name').value = projectTitle;
              document.getElementById('edit-project-color').value = projectColor;
              
              // Show the modal
              const editProjectModal = document.getElementById('edit-project-modal');
              editProjectModal.style.display = 'flex';
              setTimeout(() => {
                editProjectModal.style.opacity = '1';
                editProjectModal.style.visibility = 'visible';
                document.getElementById('edit-project-name').focus();
              }, 10);
            });
          }
        }
      });
      
      // For Task Edit Buttons - try multiple selector approaches
      document.querySelectorAll('button').forEach(button => {
        // Check if this is an edit button
        const icon = button.querySelector('.material-icons');
        if (icon && icon.textContent === 'edit') {
          // Check if it's in a task item
          const taskItem = button.closest('.task-item');
          if (taskItem) {
            // This is a task edit button
            console.log("Found task edit button", button);
            
            // Remove existing click handlers
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
            
            // Add click handler
            newButton.addEventListener('click', function(e) {
              e.preventDefault();
              e.stopPropagation();
              console.log("Task edit button clicked");
              
              // Find the task
              const taskItem = newButton.closest('.task-item');
              if (!taskItem) {
                console.error("Could not find task item");
                return;
              }
              
              const taskId = taskItem.getAttribute('data-task-id') || taskItem.id;
              const taskName = taskItem.querySelector('.task-name').textContent;
              
              console.log("Editing task:", { taskId, taskName });
              
              // Get the priority
              let priority = 'medium';
              if (taskItem.querySelector('.material-icons.priority-high') || 
                  taskItem.querySelector('.task-detail:contains("High")')) {
                priority = 'high';
              } else if (taskItem.querySelector('.material-icons.priority-low') || 
                         taskItem.querySelector('.task-detail:contains("Low")')) {
                priority = 'low';
              }
              
              // Get time and deadline if available
              let estimatedTime = '';
              let deadline = '';
              
              const detailsText = taskItem.querySelector('.task-details').textContent;
              
              taskItem.querySelectorAll('.task-detail').forEach(detail => {
                const detailText = detail.textContent.trim();
                const icon = detail.querySelector('.material-icons');
                if (icon) {
                  const iconText = icon.textContent;
                  if (iconText === 'schedule') {
                    estimatedTime = detailText.replace('schedule', '').trim();
                  } else if (iconText === 'event') {
                    deadline = detailText.replace('event', '').trim();
                  }
                }
              });
              
              console.log("Task details:", { priority, estimatedTime, deadline });
              
              // Find current project
              const projectCard = taskItem.closest('.project-card');
              const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
              
              // Populate edit form
              document.getElementById('edit-task-id').value = taskId;
              document.getElementById('edit-task-name').value = taskName;
              
              // Set priority radio button
              let priorityRadio = document.querySelector(`input[name="edit-task-priority"][value="${priority}"]`);
              if (priorityRadio) {
                priorityRadio.checked = true;
              }
              
              // Set estimated time and deadline
              document.getElementById('edit-task-time').value = estimatedTime;
              document.getElementById('edit-task-deadline').value = deadline;
              
              // Populate project dropdown
              const editTaskProjectSelect = document.getElementById('edit-task-project');
              editTaskProjectSelect.innerHTML = '';
              
              document.querySelectorAll('.project-card').forEach(project => {
                const title = project.querySelector('.project-title').textContent;
                const id = project.getAttribute('data-project-id') || project.id;
                
                const option = document.createElement('option');
                option.value = id;
                option.textContent = title;
                option.selected = (id === projectId);
                
                editTaskProjectSelect.appendChild(option);
              });
              
              // Show the modal
              const editTaskModal = document.getElementById('edit-task-modal');
              editTaskModal.style.display = 'flex';
              setTimeout(() => {
                editTaskModal.style.opacity = '1';
                editTaskModal.style.visibility = 'visible';
                document.getElementById('edit-task-name').focus();
              }, 10);
            });
          }
        }
      });
    }
  </script>

  <script>
    // ULTRA SPECIFIC FIX FOR PROJECT EDIT BUTTONS
    document.addEventListener('DOMContentLoaded', function() {
      // Run immediately and several times to ensure it catches newly rendered buttons
      fixProjectEditButtons();
      setTimeout(fixProjectEditButtons, 500);
      setTimeout(fixProjectEditButtons, 1000);
      setTimeout(fixProjectEditButtons, 2000);
      
      // Set an interval to continuously check for edit buttons
      setInterval(fixProjectEditButtons, 3000);
    });
    
    function fixProjectEditButtons() {
      console.log("🔍 ULTRA SPECIFIC FIX: Searching for project edit buttons...");
      
      // Try multiple approaches to find all project edit buttons
      const projectEditButtons = [];
      
      // Approach 1: Find by material-icons with edit text in project headers
      document.querySelectorAll('.project-header .material-icons').forEach(icon => {
        if (icon.textContent.trim() === 'edit') {
          const button = icon.closest('button');
          if (button) projectEditButtons.push(button);
        }
      });
      
      // Approach 2: Find by task-action-btn class in project headers
      document.querySelectorAll('.project-header .task-action-btn').forEach(button => {
        const icon = button.querySelector('.material-icons');
        if (icon && icon.textContent.trim() === 'edit') {
          projectEditButtons.push(button);
        }
      });
      
      // Approach 3: All buttons inside project headers
      document.querySelectorAll('.project-header button').forEach(button => {
        const icon = button.querySelector('.material-icons');
        if (icon && icon.textContent.trim() === 'edit') {
          projectEditButtons.push(button);
        }
      });
      
      // Make buttons visible by forcing style
      document.querySelectorAll('.project-header .task-actions').forEach(actionsContainer => {
        actionsContainer.style.opacity = '1';
        actionsContainer.style.display = 'flex';
        actionsContainer.style.visibility = 'visible';
      });
      
      // Log what we found
      console.log(`🔍 ULTRA SPECIFIC FIX: Found ${projectEditButtons.length} project edit buttons`);
      
      // Make each button unique to avoid duplicates
      const uniqueButtons = [];
      projectEditButtons.forEach(button => {
        if (!uniqueButtons.includes(button)) {
          uniqueButtons.push(button);
        }
      });
      
      console.log(`🔍 ULTRA SPECIFIC FIX: Processing ${uniqueButtons.length} unique project edit buttons`);
      
      // Process each unique button
      uniqueButtons.forEach((button, index) => {
        // Make the button super visible
        button.style.opacity = '1';
        button.style.visibility = 'visible';
        button.style.pointerEvents = 'auto';
        button.style.cursor = 'pointer';
        button.style.outline = '2px solid #4f46e5';
        
        // Add a special attribute to track if we've modified this button
        const isProcessed = button.getAttribute('data-edit-processed') === 'true';
        
        if (!isProcessed) {
          console.log(`🔧 ULTRA SPECIFIC FIX: Setting up project edit button ${index + 1}`);
          
          // Clone the button to remove any existing event listeners
          const newButton = button.cloneNode(true);
          button.parentNode.replaceChild(newButton, button);
          
          // Add our click handler
          newButton.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            console.log(`🎯 ULTRA SPECIFIC FIX: Project edit button ${index + 1} clicked!`);
            
            // Find the project card
            const projectCard = newButton.closest('.project-card');
            if (!projectCard) {
              console.error('❌ ULTRA SPECIFIC FIX: Could not find parent project card!');
              return;
            }
            
            // Get project details
            const projectId = projectCard.getAttribute('data-project-id') || projectCard.id || `project-${Date.now()}`;
            const projectTitle = projectCard.querySelector('.project-title')?.textContent || 'Unknown Project';
            const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color') || '#4f46e5';
            
            console.log(`📝 ULTRA SPECIFIC FIX: Editing project: ${projectTitle} (${projectId})`);
            
            // Populate the edit form
            document.getElementById('edit-project-id').value = projectId;
            document.getElementById('edit-project-name').value = projectTitle;
            document.getElementById('edit-project-color').value = projectColor;
            
            // Show the modal
            const editProjectModal = document.getElementById('edit-project-modal');
            if (!editProjectModal) {
              console.error('❌ ULTRA SPECIFIC FIX: Edit project modal not found!');
              alert('Could not find the edit project modal. Please try again.');
              return;
            }
            
            editProjectModal.style.display = 'flex';
            setTimeout(() => {
              editProjectModal.style.opacity = '1';
              editProjectModal.style.visibility = 'visible';
              document.getElementById('edit-project-name').focus();
            }, 10);
          });
          
          // Mark as processed
          newButton.setAttribute('data-edit-processed', 'true');
          
          // Add additional click handler to the icon inside for extra safety
          const icon = newButton.querySelector('.material-icons');
          if (icon) {
            icon.style.pointerEvents = 'auto';
            icon.style.cursor = 'pointer';
            icon.addEventListener('click', function(e) {
              e.stopPropagation();
              newButton.click(); // Trigger the button's click handler
            });
          }
        }
      });
    }
  </script>

  <style>
    /* EXTREME EDIT BUTTON FIX */
    .project-header .task-actions {
      opacity: 1 !important;
      display: flex !important;
      visibility: visible !important;
      pointer-events: auto !important;
    }
    
    .project-header .task-action-btn,
    .project-header button {
      opacity: 1 !important;
      visibility: visible !important;
      pointer-events: auto !important;
      cursor: pointer !important;
      z-index: 1000 !important;
    }
    
    .project-header .material-icons {
      pointer-events: auto !important;
      cursor: pointer !important;
    }
    
    /* Make edit buttons in project headers stand out */
    .project-header .task-action-btn .material-icons:contains('edit'),
    .project-header .material-icons:contains('edit') {
      color: #4f46e5 !important;
      font-size: 20px !important;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // MODIFIED: Don't automatically initialize functionality that opens modals
      console.log('Page loaded - modals should NOT automatically open');
      
      // Instead, just make sure modals are closed
      const taskModal = document.getElementById('new-task-modal');
      const projectModal = document.getElementById('new-project-modal');
      
      if (taskModal) {
        taskModal.style.display = 'none';
        taskModal.classList.remove('active');
      }
      
      if (projectModal) {
        projectModal.style.display = 'none';
        projectModal.classList.remove('active');
      }
      
      // We will NOT call initializeProjectsAndTasks() here as that was causing
      // modals to automatically open when the page loads
    });
    
    function initializeProjectsAndTasks() {
      // ... existing code ...
    }
  </script>

  <script>
    // Fix stylesheet and navigation paths for Electron
    document.addEventListener('DOMContentLoaded', function() {
      const isElectron = navigator.userAgent.toLowerCase().indexOf(' electron/') > -1;
      
      if (isElectron) {
        console.log("Running in Electron - fixing CSS and navigation paths");
        
        // Fix CSS link
        const cssLink = document.querySelector('link[href="production-fix.css"]');
        if (cssLink) {
          cssLink.setAttribute('href', './production-fix.css');
          console.log("Fixed CSS link path");
        }
        
        // Fix all navigation links
        document.querySelectorAll('a').forEach(link => {
          const href = link.getAttribute('href');
          if (href && href.endsWith('.html')) {
            // Get the filename only
            const filename = href.split('/').pop();
            // Set the link to the current directory
            link.setAttribute('href', './' + filename);
            console.log(`Fixed link: ${href} -> ./${filename}`);
          }
        });
      }
    });
  </script>

  <script>
    // Fix the Cancel and Create Task buttons in the task modal
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Applying task modal button fixes');
      
      // Fix the Cancel button
      const cancelButtons = document.querySelectorAll('#new-task-modal .close-modal, #new-task-modal button:contains("Cancel")');
      cancelButtons.forEach(button => {
        // Remove existing event listeners to avoid duplicates
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        // Add new event listener
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Cancel button clicked');
          
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
          }
        });
      });
      
      // Fix the Create Task button
      const createTaskBtn = document.getElementById('create-task-btn');
      if (createTaskBtn) {
        // Remove existing event listeners
        const newBtn = createTaskBtn.cloneNode(true);
        if (createTaskBtn.parentNode) {
          createTaskBtn.parentNode.replaceChild(newBtn, createTaskBtn);
        }
        
        // Add new event listener
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Create Task button clicked');
          
          // Get form values
          const taskName = document.getElementById('new-task-name').value.trim();
          const projectSelect = document.getElementById('new-task-project');
          const projectId = projectSelect ? projectSelect.value : '';
          
          // Basic validation
          if (!taskName) {
            alert('Please enter a task name');
            return;
          }
          
          if (!projectId) {
            alert('Please select a project');
            return;
          }
          
          // Get optional values
          let priority = 'medium';
          const priorityInputs = document.querySelectorAll('input[name="new-task-priority"]');
          priorityInputs.forEach(input => {
            if (input.checked) {
              priority = input.value;
            }
          });
          
          const estimatedTime = document.getElementById('new-task-time').value || '1 hr';
          const deadline = document.getElementById('new-task-deadline').value || '';
          
          // Find the project
          const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
          if (!projectCard) {
            console.error('Project not found:', projectId);
            alert('Error: Project not found. Please try again.');
            return;
          }
          
          // Create a new task element
          const taskId = 'task-' + Date.now();
          const taskHTML = `
            <div class="task-item" data-task-id="${taskId}">
              <input type="checkbox" class="task-checkbox">
              <div class="task-content">
                <h4 class="task-name">${taskName}</h4>
                <div class="task-details">
                  <span class="task-detail">
                    <span class="material-icons priority-${priority}">${priority === 'high' ? 'flag' : priority === 'medium' ? 'outlined_flag' : 'assistant_flag'}</span>
                    ${priority.charAt(0).toUpperCase() + priority.slice(1)}
                  </span>
                  <span class="task-detail">
                    <span class="material-icons">schedule</span>
                    ${estimatedTime}
                  </span>
                  ${deadline ? `
                  <span class="task-detail">
                    <span class="material-icons">event</span>
                    ${new Date(deadline).toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}
                  </span>
                  ` : ''}
                </div>
              </div>
              <div class="task-actions">
                <button class="task-action-btn edit-task-btn">
                  <span class="material-icons">edit</span>
                </button>
                <button class="task-action-btn delete-task-btn">
                  <span class="material-icons">delete</span>
                </button>
              </div>
            </div>
          `;
          
          // Add the task to the project's task list
          const taskList = projectCard.querySelector('.task-list');
          if (!taskList) {
            console.error('Task list not found in project:', projectId);
            alert('Error: Could not add task to project. Please try again.');
            return;
          }
          
          // Remove empty message if present
          const emptyMessage = taskList.querySelector('.empty-tasks-message');
          if (emptyMessage) {
            emptyMessage.remove();
          }
          
          // Add task to the list
          taskList.insertAdjacentHTML('beforeend', taskHTML);
          
          // Update project progress
          const tasks = projectCard.querySelectorAll('.task-item');
          const completedTasks = projectCard.querySelectorAll('.task-item .task-checkbox:checked').length;
          const progressPercent = Math.round((completedTasks / tasks.length) * 100) || 0;
          
          const progressText = projectCard.querySelector('.project-progress');
          const progressFill = projectCard.querySelector('.progress-fill');
          
          if (progressText) progressText.textContent = `${progressPercent}% complete`;
          if (progressFill) progressFill.style.width = `${progressPercent}%`;
          
          // Save to localStorage
          try {
            // Get existing data
            let projectsData = JSON.parse(localStorage.getItem('tempus-projects-data') || '[]');
            
            // Find or create project data
            let projectData = projectsData.find(p => p.id === projectId);
            if (!projectData) {
              projectData = {
                id: projectId,
                name: projectCard.querySelector('.project-title').textContent,
                tasks: []
              };
              projectsData.push(projectData);
            }
            
            // Add task to project data
            projectData.tasks.push({
              id: taskId,
              name: taskName,
              priority: priority,
              estimatedTime: estimatedTime,
              deadline: deadline,
              completed: false
            });
            
            // Save updated data
            localStorage.setItem('tempus-projects-data', JSON.stringify(projectsData));
            console.log('Project data saved to localStorage');
          } catch (err) {
            console.error('Error saving to localStorage:', err);
          }
          
          // Close the modal
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
          }
          
          // Reset the form
          const taskForm = document.getElementById('new-task-form');
          if (taskForm) {
            taskForm.reset();
          }
          
          // Setup the edit and delete buttons for the new task
          const newTask = taskList.querySelector(`[data-task-id="${taskId}"]`);
          if (newTask) {
            // Add event listeners for the checkbox
            const checkbox = newTask.querySelector('.task-checkbox');
            if (checkbox) {
              checkbox.addEventListener('change', function() {
                if (this.checked) {
                  newTask.classList.add('completed');
                } else {
                  newTask.classList.remove('completed');
                }
                
                // Update project progress
                const allTasks = projectCard.querySelectorAll('.task-item');
                const completedTasks = projectCard.querySelectorAll('.task-item.completed, .task-item input:checked');
                const progressPercent = Math.round((completedTasks.length / allTasks.length) * 100) || 0;
                
                if (progressText) progressText.textContent = `${progressPercent}% complete`;
                if (progressFill) progressFill.style.width = `${progressPercent}%`;
              });
            }
            
            // Add event listeners for the edit button
            const editBtn = newTask.querySelector('.edit-task-btn');
            if (editBtn) {
              editBtn.addEventListener('click', function() {
                alert('Edit functionality will be implemented soon!');
              });
            }
            
            // Add event listeners for the delete button
            const deleteBtn = newTask.querySelector('.delete-task-btn');
            if (deleteBtn) {
              deleteBtn.addEventListener('click', function() {
                if (confirm(`Are you sure you want to delete the task "${taskName}"?`)) {
                  // Remove task
                  newTask.remove();
                  
                  // Update project progress
                  const allTasks = projectCard.querySelectorAll('.task-item');
                  const completedTasks = projectCard.querySelectorAll('.task-item.completed, .task-item input:checked');
                  const progressPercent = allTasks.length ? Math.round((completedTasks.length / allTasks.length) * 100) : 0;
                  
                  if (progressText) progressText.textContent = `${progressPercent}% complete`;
                  if (progressFill) progressFill.style.width = `${progressPercent}%`;
                  
                  // Add empty message if no tasks
                  if (allTasks.length === 0) {
                    taskList.innerHTML = '<div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>';
                  }
                }
              });
            }
          }
          
          // Show success message
          alert(`Task "${taskName}" created successfully!`);
        });
      }
      
      // Make sure the "Add Task" buttons in project cards also work
      document.querySelectorAll('.add-task-btn').forEach(button => {
        button.addEventListener('click', function() {
          const projectCard = this.closest('.project-card');
          if (projectCard) {
            const projectId = projectCard.getAttribute('data-project-id');
            const projectName = projectCard.querySelector('.project-title').textContent;
            
            // Open the new task modal
            const modal = document.getElementById('new-task-modal');
            if (modal) {
              // Reset the form
              const form = document.getElementById('new-task-form');
              if (form) form.reset();
              
              // Pre-select the project
              const projectSelect = document.getElementById('new-task-project');
              if (projectSelect) {
                for (let i = 0; i < projectSelect.options.length; i++) {
                  if (projectSelect.options[i].value === projectId) {
                    projectSelect.selectedIndex = i;
                    break;
                  }
                }
              }
              
              // Show the modal
              modal.style.display = 'flex';
              modal.classList.add('active');
            }
          }
        });
      });
    });
  </script>

  <!-- Disable automatic task modal popup on page load -->
  <script>
    // Disable automatic task modal popup on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Preventing automatic modal popup');
      
      // Find any automatic task modal triggers and disable them
      let hasAutoTrigger = false;
      
      // Check for any setTimeout that might be triggering the modal
      const originalSetTimeout = window.setTimeout;
      window.setTimeout = function(fn, delay) {
        if (typeof fn === 'function' && fn.toString().includes('openNewTaskModal') && delay < 1000) {
          console.log('Blocked automatic modal popup from setTimeout');
          hasAutoTrigger = true;
          return 0; // Return a timeout ID that does nothing
        }
        return originalSetTimeout.apply(this, arguments);
      };
      
      // Force close any modals that might be open
      setTimeout(function() {
        const taskModal = document.getElementById('new-task-modal');
        const projectModal = document.getElementById('new-project-modal');
        
        if (taskModal) {
          taskModal.style.display = 'none';
          taskModal.classList.remove('active');
          console.log('Force closed task modal');
        }
        
        if (projectModal) {
          projectModal.style.display = 'none';
          projectModal.classList.remove('active');
          console.log('Force closed project modal');
        }
      }, 100);
      
      // Make sure only the "New Task" and "New Project" buttons can open the modals
      const newTaskBtn = document.getElementById('new-task-btn');
      if (newTaskBtn) {
        // Remove existing event listeners
        const newBtn = newTaskBtn.cloneNode(true);
        if (newTaskBtn.parentNode) {
          newTaskBtn.parentNode.replaceChild(newBtn, newTaskBtn);
        }
        
        // Add a clean event listener
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('New Task button clicked properly');
          
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            // Reset the form
            const form = document.getElementById('new-task-form');
            if (form) form.reset();
            
            // Populate the project dropdown
            const projectSelect = document.getElementById('new-task-project');
            if (projectSelect) {
              projectSelect.innerHTML = '';
              const projects = document.querySelectorAll('.project-card');
              
              if (projects.length === 0) {
                alert('Please create a project first before adding tasks.');
                return;
              }
              
              projects.forEach(project => {
                const projectTitle = project.querySelector('.project-title');
                const projectId = project.getAttribute('data-project-id') || 
                                 (project.id ? project.id : 'project-' + Date.now());
                
                if (projectTitle) {
                  const option = document.createElement('option');
                  option.value = projectId;
                  option.textContent = projectTitle.textContent;
                  projectSelect.appendChild(option);
                }
              });
            }
            
            // Show the modal
            modal.style.display = 'flex';
            modal.classList.add('active');
            
            // Focus the name input
            const nameInput = document.getElementById('new-task-name');
            if (nameInput) {
              setTimeout(() => {
                nameInput.focus();
              }, 100);
            }
          }
        });
      }
      
      // Do the same for the New Project button
      const newProjectBtn = document.getElementById('new-project-btn');
      if (newProjectBtn) {
        // Remove existing event listeners
        const newBtn = newProjectBtn.cloneNode(true);
        if (newProjectBtn.parentNode) {
          newProjectBtn.parentNode.replaceChild(newBtn, newProjectBtn);
        }
        
        // Add a clean event listener
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('New Project button clicked properly');
          
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            // Reset the form
            const form = document.getElementById('new-project-form');
            if (form) form.reset();
            
            // Show the modal
            modal.style.display = 'flex';
            modal.classList.add('active');
            
            // Focus the name input
            const nameInput = document.getElementById('new-project-name');
            if (nameInput) {
              setTimeout(() => {
                nameInput.focus();
              }, 100);
            }
          }
        });
      }
    });
  </script>

  <script>
    // Fix Project Edit modal buttons functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Fixing Project Edit modal buttons functionality');
      
      // Fix modal close button (X)
      const closeModalButtons = document.querySelectorAll('#edit-project-modal .close-modal');
      closeModalButtons.forEach(button => {
        // Remove existing handlers
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        // Add new event handler
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Edit Project close button clicked');
          
          const modal = document.getElementById('edit-project-modal');
          if (modal) {
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';
          }
        });
      });
      
      // Fix Cancel button
      const cancelButtons = document.querySelectorAll('#edit-project-modal .secondary-btn, #edit-project-modal button:contains("Cancel")');
      cancelButtons.forEach(button => {
        // Remove existing handlers
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        // Add new event handler
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Edit Project Cancel button clicked');
          
          const modal = document.getElementById('edit-project-modal');
          if (modal) {
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';
          }
        });
      });
      
      // Fix Update Project button
      const updateProjectBtn = document.getElementById('update-project-btn');
      if (updateProjectBtn) {
        // Remove existing handlers
        const newBtn = updateProjectBtn.cloneNode(true);
        if (updateProjectBtn.parentNode) {
          updateProjectBtn.parentNode.replaceChild(newBtn, updateProjectBtn);
        }
        
        // Add new event handler
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('Update Project button clicked');
          
          // Get form values
          const projectId = document.getElementById('edit-project-id').value;
          const projectName = document.getElementById('edit-project-name').value.trim();
          const projectColor = document.getElementById('edit-project-color').value;
          
          // Basic validation
          if (!projectName) {
            alert('Please enter a project name');
            return;
          }
          
          // Find the project card
          const projectCard = document.querySelector(`.project-card[data-project-id="${projectId}"]`);
          if (!projectCard) {
            console.error('Project not found:', projectId);
            alert('Error: Project not found. Please try again.');
            return;
          }
          
          // Update project title
          const titleEl = projectCard.querySelector('.project-title');
          if (titleEl) {
            titleEl.textContent = projectName;
          }
          
          // Update project color
          projectCard.style.setProperty('--project-color', projectColor);
          
          // Save to localStorage
          try {
            // Get existing data
            let projectsData = JSON.parse(localStorage.getItem('tempus_projects') || '[]');
            
            // Find or create project data
            let projectDataIndex = projectsData.findIndex(p => p.id === projectId);
            if (projectDataIndex >= 0) {
              projectsData[projectDataIndex].title = projectName;
              projectsData[projectDataIndex].color = projectColor;
            }
            
            // Save updated data
            localStorage.setItem('tempus_projects', JSON.stringify(projectsData));
            console.log('Project data saved to localStorage');
            
            // Show success message
            alert(`Project "${projectName}" updated successfully!`);
          } catch (err) {
            console.error('Error saving to localStorage:', err);
            alert('Error updating project. Please try again.');
          }
          
          // Close the modal
          const modal = document.getElementById('edit-project-modal');
          if (modal) {
            modal.style.display = 'none';
            modal.style.opacity = '0';
            modal.style.visibility = 'hidden';
          }
        });
      }
    });
  </script>

  <script>
    // Add complete functionality for all elements in the Projects & Tasks UI
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing full Projects & Tasks functionality');
      
      // 1. Fix filter buttons functionality
      initializeFilterButtons();
      
      // 2. Fix project action buttons (edit, delete, more options)
      initializeProjectActionButtons();
      
      // 3. Fix task checkboxes and related functionality
      initializeTaskCheckboxes();
      
      // 4. Fix "New Task" and "Click to add task" functionality
      initializeTaskAddFunctionality();
      
      // Apply these fixes periodically to catch dynamically added elements
      setInterval(function() {
        initializeProjectActionButtons();
        initializeTaskCheckboxes();
      }, 1000);
    });
    
    // Filter functionality
    function initializeFilterButtons() {
      console.log('Setting up filter buttons');
      
      // Status filters (All, Active, Completed)
      const statusButtons = document.querySelectorAll('[data-filter-status], .status-filter button');
      statusButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all status buttons
          statusButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          
          // Apply filters
          applyFilters();
        });
      });
      
      // Priority filters (All, High, Medium, Low)
      const priorityButtons = document.querySelectorAll('[data-filter-priority], .priority-filter button');
      priorityButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all priority buttons
          priorityButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          
          // Apply filters
          applyFilters();
        });
      });
      
      // Project filters (All, Website, Mobile App, Marketing)
      const projectButtons = document.querySelectorAll('[data-filter-project], .project-filter button');
      projectButtons.forEach(button => {
        button.addEventListener('click', function() {
          // Remove active class from all project buttons
          projectButtons.forEach(btn => btn.classList.remove('active'));
          // Add active class to clicked button
          this.classList.add('active');
          
          // Apply filters
          applyFilters();
        });
      });
    }
    
    // Function to apply all filters
    function applyFilters() {
      // Get active filters
      const statusFilter = document.querySelector('[data-filter-status].active, .status-filter button.active')?.textContent.trim() || 'All';
      const priorityFilter = document.querySelector('[data-filter-priority].active, .priority-filter button.active')?.textContent.trim() || 'All';
      const projectFilter = document.querySelector('[data-filter-project].active, .project-filter button.active')?.textContent.trim() || 'All';
      
      console.log('Applying filters:', { statusFilter, priorityFilter, projectFilter });
      
      // Loop through all project cards
      document.querySelectorAll('.project-card').forEach(projectCard => {
        const projectTitle = projectCard.querySelector('.project-title')?.textContent.trim();
        let showProject = true;
        
        // Apply project filter
        if (projectFilter !== 'All' && projectTitle !== projectFilter) {
          showProject = false;
        }
        
        // Show/hide the project card
        projectCard.style.display = showProject ? '' : 'none';
      });
      
      // Loop through all task items
      document.querySelectorAll('.task-item').forEach(taskItem => {
        const projectCard = taskItem.closest('.project-card');
        const projectTitle = projectCard.querySelector('.project-title')?.textContent.trim();
        
        // Check task status
        const isCompleted = taskItem.classList.contains('completed') || taskItem.querySelector('.task-checkbox')?.checked;
        let showTask = true;
        
        // Apply status filter
        if (statusFilter === 'Active' && isCompleted) {
          showTask = false;
        } else if (statusFilter === 'Completed' && !isCompleted) {
          showTask = false;
        }
        
        // Apply priority filter
        const taskPriority = 
          taskItem.querySelector('.priority-high') ? 'High' : 
          taskItem.querySelector('.priority-low') ? 'Low' : 'Medium';
          
        if (priorityFilter !== 'All' && taskPriority !== priorityFilter) {
          showTask = false;
        }
        
        // Apply project filter (if project card is hidden, hide all its tasks)
        if (projectCard.style.display === 'none') {
          showTask = false;
        }
        
        // Show/hide the task item
        taskItem.style.display = showTask ? '' : 'none';
      });
    }
    
    // Project action buttons (edit, delete, more options)
    function initializeProjectActionButtons() {
      console.log('Setting up project action buttons');
      
      // Edit buttons (pencil icons)
      document.querySelectorAll('.project-card .edit-button, .project-card [title="Edit"]').forEach(button => {
        // Remove existing listeners to avoid duplicates
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const projectCard = this.closest('.project-card');
          const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
          const projectTitle = projectCard.querySelector('.project-title')?.textContent || '';
          const projectColor = getComputedStyle(projectCard).getPropertyValue('--project-color') || '#4f46e5';
          
          console.log('Editing project:', projectTitle);
          
          // Populate edit form
          document.getElementById('edit-project-id').value = projectId;
          document.getElementById('edit-project-name').value = projectTitle;
          document.getElementById('edit-project-color').value = projectColor;
          
          // Show edit modal
          const editModal = document.getElementById('edit-project-modal');
          editModal.style.display = 'flex';
          editModal.style.opacity = '1';
          editModal.style.visibility = 'visible';
        });
      });
      
      // Delete buttons (trash icons)
      document.querySelectorAll('.project-card .delete-button, .project-card [title="Delete"]').forEach(button => {
        // Remove existing listeners to avoid duplicates
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const projectCard = this.closest('.project-card');
          const projectTitle = projectCard.querySelector('.project-title')?.textContent || '';
          
          if (confirm(`Are you sure you want to delete the project "${projectTitle}" and all its tasks?`)) {
            console.log('Deleting project:', projectTitle);
            projectCard.remove();
            
            // Update localStorage
            try {
              const projectsData = JSON.parse(localStorage.getItem('tempus_projects') || '[]');
              const updatedData = projectsData.filter(p => p.title !== projectTitle);
              localStorage.setItem('tempus_projects', JSON.stringify(updatedData));
            } catch (err) {
              console.error('Error updating localStorage:', err);
            }
          }
        });
      });
      
      // More options buttons (three dots)
      document.querySelectorAll('.project-card .more-options, .project-card [title="More Options"]').forEach(button => {
        // Remove existing listeners to avoid duplicates
        const newBtn = button.cloneNode(true);
        if (button.parentNode) {
          button.parentNode.replaceChild(newBtn, button);
        }
        
        newBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          
          const projectCard = this.closest('.project-card');
          const projectTitle = projectCard.querySelector('.project-title')?.textContent || '';
          
          console.log('More options for project:', projectTitle);
          
          // Create and show dropdown menu
          let menu = document.querySelector('.project-options-menu');
          if (!menu) {
            menu = document.createElement('div');
            menu.className = 'project-options-menu';
            menu.innerHTML = `
              <div class="menu-item edit-project">Edit Project</div>
              <div class="menu-item delete-project">Delete Project</div>
              <div class="menu-item duplicate-project">Duplicate Project</div>
            `;
            document.body.appendChild(menu);
            
            // Add event listeners to menu items
            menu.querySelector('.edit-project').addEventListener('click', function() {
              document.querySelector(`.project-card[data-project-id="${projectCard.getAttribute('data-project-id')}"] .edit-button`)?.click();
              menu.style.display = 'none';
            });
            
            menu.querySelector('.delete-project').addEventListener('click', function() {
              document.querySelector(`.project-card[data-project-id="${projectCard.getAttribute('data-project-id')}"] .delete-button`)?.click();
              menu.style.display = 'none';
            });
            
            menu.querySelector('.duplicate-project').addEventListener('click', function() {
              const newProject = projectCard.cloneNode(true);
              const newId = 'project-' + Date.now();
              newProject.setAttribute('data-project-id', newId);
              newProject.id = newId;
              newProject.querySelector('.project-title').textContent = projectTitle + ' (Copy)';
              
              // Reset progress
              newProject.querySelector('.project-progress').textContent = '0% complete';
              newProject.querySelector('.progress-fill').style.width = '0%';
              
              // Clear tasks
              const taskList = newProject.querySelector('.task-list');
              taskList.innerHTML = '<div class="empty-tasks-message">No tasks yet. Click "New Task" to add one.</div>';
              
              projectCard.parentNode.appendChild(newProject);
              menu.style.display = 'none';
              
              // Setup action buttons for the new project
              initializeProjectActionButtons();
            });
          }
          
          // Position menu near the button
          const rect = this.getBoundingClientRect();
          menu.style.top = (rect.bottom + window.scrollY) + 'px';
          menu.style.left = (rect.left + window.scrollX) + 'px';
          menu.style.display = 'block';
          
          // Close menu when clicking outside
          const closeMenu = function(e) {
            if (!menu.contains(e.target) && e.target !== newBtn) {
              menu.style.display = 'none';
              document.removeEventListener('click', closeMenu);
            }
          };
          
          // Use setTimeout to avoid immediate closing
          setTimeout(() => {
            document.addEventListener('click', closeMenu);
          }, 0);
        });
      });
    }
    
    // Task checkboxes functionality
    function initializeTaskCheckboxes() {
      console.log('Setting up task checkboxes');
      
      document.querySelectorAll('.task-item .task-checkbox').forEach(checkbox => {
        // Skip if already initialized
        if (checkbox.hasAttribute('data-initialized')) return;
        
        checkbox.setAttribute('data-initialized', 'true');
        
        checkbox.addEventListener('change', function() {
          const taskItem = this.closest('.task-item');
          const projectCard = this.closest('.project-card');
          
          // Update task style
          if (this.checked) {
            taskItem.classList.add('completed');
          } else {
            taskItem.classList.remove('completed');
          }
          
          // Update project progress
          updateProjectProgress(projectCard);
          
          // Save to localStorage
          try {
            saveProjectsData();
          } catch (err) {
            console.error('Error saving task status:', err);
          }
        });
      });
    }
    
    // Task add functionality
    function initializeTaskAddFunctionality() {
      console.log('Setting up task add functionality');
      
      // New Task button at the top
      const newTaskButton = document.querySelector('#new-task-btn, button:contains("New Task")');
      if (newTaskButton) {
        newTaskButton.addEventListener('click', function() {
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            // Reset form
            const form = document.getElementById('new-task-form');
            if (form) form.reset();
            
            // Populate project dropdown
            const projectSelect = document.getElementById('new-task-project');
            if (projectSelect) {
              projectSelect.innerHTML = '';
              document.querySelectorAll('.project-card').forEach(project => {
                const projectTitle = project.querySelector('.project-title').textContent;
                const projectId = project.getAttribute('data-project-id') || project.id;
                
                const option = document.createElement('option');
                option.value = projectId;
                option.textContent = projectTitle;
                projectSelect.appendChild(option);
              });
            }
            
            // Show modal
            modal.style.display = 'flex';
            modal.classList.add('active');
          }
        });
      }
      
      // New Project button at the top
      const newProjectButton = document.querySelector('#new-project-btn, button:contains("New Project")');
      if (newProjectButton) {
        newProjectButton.addEventListener('click', function() {
          const modal = document.getElementById('new-project-modal');
          if (modal) {
            // Reset form
            const form = document.getElementById('new-project-form');
            if (form) form.reset();
            
            // Show modal
            modal.style.display = 'flex';
            modal.classList.add('active');
          }
        });
      }
      
      // "No tasks yet. Click 'New Task' to add one." text
      document.querySelectorAll('.empty-tasks-message, [contains="Click \"New Task\""]').forEach(element => {
        element.style.cursor = 'pointer';
        element.addEventListener('click', function() {
          // Find the project card
          const projectCard = this.closest('.project-card');
          const projectId = projectCard.getAttribute('data-project-id') || projectCard.id;
          const projectTitle = projectCard.querySelector('.project-title').textContent;
          
          // Open the new task modal
          const modal = document.getElementById('new-task-modal');
          if (modal) {
            // Reset form
            const form = document.getElementById('new-task-form');
            if (form) form.reset();
            
            // Pre-select the current project
            const projectSelect = document.getElementById('new-task-project');
            if (projectSelect) {
              projectSelect.innerHTML = '';
              document.querySelectorAll('.project-card').forEach(project => {
                const title = project.querySelector('.project-title').textContent;
                const id = project.getAttribute('data-project-id') || project.id;
                
                const option = document.createElement('option');
                option.value = id;
                option.textContent = title;
                option.selected = (id === projectId);
                projectSelect.appendChild(option);
              });
            }
            
            // Show modal
            modal.style.display = 'flex';
            modal.classList.add('active');
          }
        });
      });
    }
    
    // Helper function to update project progress
    function updateProjectProgress(projectCard) {
      if (!projectCard) return;
      
      const tasks = projectCard.querySelectorAll('.task-item');
      const totalTasks = tasks.length;
      
      if (totalTasks === 0) {
        const progressBar = projectCard.querySelector('.progress-fill');
        const progressText = projectCard.querySelector('.project-progress');
        
        if (progressBar) progressBar.style.width = '0%';
        if (progressText) progressText.textContent = '0% complete';
        return;
      }
      
      const completedTasks = projectCard.querySelectorAll('.task-item.completed, .task-item .task-checkbox:checked').length;
      const progressPercent = Math.round((completedTasks / totalTasks) * 100);
      
      const progressBar = projectCard.querySelector('.progress-fill');
      const progressText = projectCard.querySelector('.project-progress');
      
      if (progressBar) progressBar.style.width = `${progressPercent}%`;
      if (progressText) progressText.textContent = `${progressPercent}% complete`;
    }
    
    // CSS for the dropdown menu
    const style = document.createElement('style');
    style.textContent = `
      .project-options-menu {
        position: absolute;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        z-index: 1000;
        display: none;
      }
      
      .project-options-menu .menu-item {
        padding: 10px 15px;
        cursor: pointer;
      }
      
      .project-options-menu .menu-item:hover {
        background-color: #f3f4f6;
      }
      
      .project-options-menu .delete-project {
        color: #ef4444;
      }
      
      /* Dark mode */
      [data-theme="dark"] .project-options-menu {
        background: #1f2937;
        border-color: #374151;
      }
      
      [data-theme="dark"] .project-options-menu .menu-item:hover {
        background-color: #374151;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html> 